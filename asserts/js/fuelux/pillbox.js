(function(c){"function"===typeof define&&define.amd?define(["jquery","fuelux/dropdown-autoflip"],c):c(jQuery)})(function(c){if(!c.fn.dropdownautoflip)throw Error("Fuel UX pillbox control requires dropdown-autoflip.");var l=c.fn.pillbox,k=function(a,b){this.$element=c(a);this.$moreCount=this.$element.find(".pillbox-more-count");this.$pillGroup=this.$element.find(".pill-group");this.$addItem=this.$element.find(".pillbox-add-item");this.$addItemWrap=this.$addItem.parent();this.$suggest=this.$element.find(".suggest");
this.$pillHTML='<li class="btn btn-default pill">\t<span></span>\t<span class="glyphicon glyphicon-close">\t\t<span class="sr-only">Remove</span>\t</span></li>';this.options=c.extend({},c.fn.pillbox.defaults,b);-1===this.options.readonly?void 0!==this.$element.attr("data-readonly")&&this.readonly(!0):this.options.readonly&&this.readonly(!0);this.acceptKeyCodes=this._generateObject(this.options.acceptKeyCodes);this.$element.on("click.fu.pillbox",".pill-group > .pill",c.proxy(this.itemClicked,this));
this.$element.on("click.fu.pillbox",c.proxy(this.inputFocus,this));this.$element.on("keydown.fu.pillbox",".pillbox-add-item",c.proxy(this.inputEvent,this));if(this.options.onKeyDown)this.$element.on("mousedown.fu.pillbox",".suggest > li",c.proxy(this.suggestionClick,this));this.options.edit&&(this.$element.addClass("pills-editable"),this.$element.on("blur.fu.pillbox",".pillbox-add-item",c.proxy(this.cancelEdit,this)))};k.prototype={constructor:k,destroy:function(){this.$element.remove();return this.$element[0].outerHTML},
items:function(){var a=this;return this.$pillGroup.children(".pill").map(function(){return a.getItemData(c(this))}).get()},itemClicked:function(a){var b=c(a.target);a.preventDefault();a.stopPropagation();this._closeSuggestions();if(b.hasClass("pill"))a=b;else if(a=b.parent(),void 0===this.$element.attr("data-readonly")){if(b.hasClass("glyphicon-close")){if(this.options.onRemove)this.options.onRemove(this.getItemData(a,{el:a}),c.proxy(this._removeElement,this));else this._removeElement(this.getItemData(a,
{el:a}));return!1}if(this.options.edit){if(a.find(".pillbox-list-edit").length)return!1;this.openEdit(a)}}this.$element.trigger("clicked.fu.pillbox",this.getItemData(a))},readonly:function(a){a?this.$element.attr("data-readonly","readonly"):this.$element.removeAttr("data-readonly");this.options.truncate&&this.truncate(a)},suggestionClick:function(a){var b=c(a.currentTarget),d={text:b.html(),value:b.data("value")};a.preventDefault();this.$addItem.val("");b.data("attr")&&(d.attr=JSON.parse(b.data("attr")));
d.data=b.data("data");this.addItems(d,!0);this._closeSuggestions()},itemCount:function(){return this.$pillGroup.children(".pill").length},addItems:function(){var a=this,b,d,e;!isFinite(String(arguments[0]))||arguments[0]instanceof Array?(b=[].slice.call(arguments).slice(0),e=b[1]&&!b[1].text):(b=[].slice.call(arguments).slice(1),d=arguments[0]);b[0]instanceof Array&&(b=b[0]);if(b.length)if(c.each(b,function(d,c){var e={text:c.text,value:c.value?c.value:c.text,el:a.$pillHTML};c.attr&&(e.attr=c.attr);
c.data&&(e.data=c.data);b[d]=e}),this.options.edit&&this.currentEdit&&(b[0].el=this.currentEdit.wrap("<div></div>").parent().html()),e&&b.pop(1),a.options.onAdd&&e)if(this.options.edit&&this.currentEdit)a.options.onAdd(b[0],c.proxy(a.saveEdit,this));else a.options.onAdd(b[0],c.proxy(a.placeItems,this));else this.options.edit&&this.currentEdit?a.saveEdit(b):d?a.placeItems(d,b):a.placeItems(b,e)},removeItems:function(a,b){var d,c;if(a)for(b=b?b:1,d=0;d<b;d++)if(c=this.$pillGroup.find("> .pill:nth-child("+
a+")"))c.remove();else break;else this.$pillGroup.find(".pill").remove(),this._removePillTrigger({method:"removeAll"})},placeItems:function(){var a=[],b,d,e;!isFinite(String(arguments[0]))||arguments[0]instanceof Array?(b=[].slice.call(arguments).slice(0),e=b[1]&&!b[1].text):(b=[].slice.call(arguments).slice(1),d=arguments[0]);b[0]instanceof Array&&(b=b[0]);b.length&&(c.each(b,function(b,d){var e=c(d.el);e.attr("data-value",d.value);e.find("span:first").html(d.text);d.attr&&c.each(d.attr,function(a,
b){"cssClass"===a||"class"===a?e.addClass(b):e.attr(a,b)});d.data&&e.data("data",d.data);a.push(e)}),0<this.$pillGroup.children(".pill").length?d?(d=this.$pillGroup.find(".pill:nth-child("+d+")"),d.length?d.before(a):this.$pillGroup.children(".pill:last").after(a)):this.$pillGroup.children(".pill:last").after(a):this.$pillGroup.prepend(a),e&&this.$element.trigger("added.fu.pillbox",{text:b[0].text,value:b[0].value}))},inputEvent:function(a){var b=this,d=this.$addItem.val(),c,g,f;if(this.acceptKeyCodes[a.keyCode]){this.options.onKeyDown&&
this._isSuggestionsOpen()&&(f=this.$suggest.find(".pillbox-suggest-sel"),f.length&&(d=f.html(),c=f.data("value"),g=f.data("attr")));if(d.replace(/[ ]*\,[ ]*/,"").match(/\S/)||this.options.allowEmptyPills&&d.length)this._closeSuggestions(),this.$addItem.hide(),g?this.addItems({text:d,value:c,attr:JSON.parse(g)},!0):this.addItems({text:d,value:c},!0),setTimeout(function(){b.$addItem.show().val("").attr({size:10})},0);a.preventDefault();return!0}if(8===a.keyCode||46===a.keyCode){if(!d.length){a.preventDefault();
if(this.options.edit&&this.currentEdit)return this.cancelEdit(),!0;this._closeSuggestions();d=this.$pillGroup.children(".pill:last");d.hasClass("pillbox-highlight")?this._removeElement(this.getItemData(d,{el:d})):d.addClass("pillbox-highlight");return!0}}else 10<d.length&&this.$addItem.width()<this.$pillGroup.width()-6&&this.$addItem.attr({size:d.length+3});this.$pillGroup.find(".pill").removeClass("pillbox-highlight");if(this.options.onKeyDown){if(9===a.keyCode||38===a.keyCode||40===a.keyCode)return this._isSuggestionsOpen()&&
this._keySuggestions(a),!0;this.callbackId=a.timeStamp;this.options.onKeyDown({event:a,value:d},function(d){b._openSuggestions(a,d)})}},openEdit:function(a){var b=a.index()+1,d=this.$addItemWrap.detach().hide();this.$pillGroup.find(".pill:nth-child("+b+")").before(d);this.currentEdit=a.detach();d.addClass("editing");this.$addItem.val(a.find("span:first").html());d.show();this.$addItem.focus().select()},cancelEdit:function(a){if(!this.currentEdit)return!1;this._closeSuggestions();a&&this.$addItemWrap.before(this.currentEdit);
this.currentEdit=!1;a=this.$addItemWrap.detach();a.removeClass("editing");this.$addItem.val("");this.$pillGroup.append(a)},saveEdit:function(a){a=a[0]?a[0]:a;this.currentEdit=c(a.el);this.currentEdit.data("value",a.value);this.currentEdit.find("span:first").html(a.text);this.$addItemWrap.hide();this.$addItemWrap.before(this.currentEdit);this.currentEdit=!1;this.$addItem.val("");this.$addItemWrap.removeClass("editing");this.$pillGroup.append(this.$addItemWrap.detach().show());this.$element.trigger("edited.fu.pillbox",
{value:a.value,text:a.text})},removeBySelector:function(){var a=[].slice.call(arguments).slice(0),b=this;c.each(a,function(a,c){b.$pillGroup.find(c).remove()});this._removePillTrigger({method:"removeBySelector",removedSelectors:a})},removeByValue:function(){var a=[].slice.call(arguments).slice(0),b=this;c.each(a,function(a,c){b.$pillGroup.find('> .pill[data-value="'+c+'"]').remove()});this._removePillTrigger({method:"removeByValue",removedValues:a})},removeByText:function(){var a=[].slice.call(arguments).slice(0),
b=this;c.each(a,function(a,c){b.$pillGroup.find('> .pill:contains("'+c+'")').remove()});this._removePillTrigger({method:"removeByText",removedText:a})},truncate:function(a){var b=this,d,e,g,f,h;this.$element.removeClass("truncate");this.$addItemWrap.removeClass("truncated");this.$pillGroup.find(".pill").removeClass("truncated");a&&(this.$element.addClass("truncate"),d=this.$element.width(),e=!1,g=0,f=this.$pillGroup.find(".pill").length,h=0,this.$pillGroup.find(".pill").each(function(){var a=c(this);
e?a.addClass("truncated"):(g++,b.$moreCount.text(f-g),h+a.outerWidth(!0)+b.$addItemWrap.outerWidth(!0)<=d?h+=a.outerWidth(!0):(b.$moreCount.text(f-g+1),a.addClass("truncated"),e=!0))}),g===f&&this.$addItemWrap.addClass("truncated"))},inputFocus:function(a){this.$element.find(".pillbox-add-item").focus()},getItemData:function(a,b){return c.extend({text:a.find("span:first").html()},a.data(),b)},_removeElement:function(a){a.el.remove();delete a.el;this.$element.trigger("removed.fu.pillbox",a)},_removePillTrigger:function(a){this.$element.trigger("removed.fu.pillbox",
a)},_generateObject:function(a){var b={};c.each(a,function(a,c){b[c]=!0});return b},_openSuggestions:function(a,b){var d=c("<ul>");if(this.callbackId!==a.timeStamp)return!1;b.data&&b.data.length&&(c.each(b.data,function(a,b){var f=c('<li data-value="'+(b.value?b.value:b.text)+'">'+b.text+"</li>");b.attr&&f.data("attr",JSON.stringify(b.attr));b.data&&f.data("data",b.data);d.append(f)}),this.$suggest.html("").append(d.children()),c(document.body).trigger("suggested.fu.pillbox",this.$suggest))},_closeSuggestions:function(){this.$suggest.html("").parent().removeClass("open")},
_isSuggestionsOpen:function(){return this.$suggest.parent().hasClass("open")},_keySuggestions:function(a){var b=this.$suggest.find("li.pillbox-suggest-sel"),c=38===a.keyCode;a.preventDefault();b.length?(a=c?b.prev():b.next(),a.length||(a=c?this.$suggest.find("li:last"):this.$suggest.find("li:first")),a&&(a.addClass("pillbox-suggest-sel"),b.removeClass("pillbox-suggest-sel"))):(b=this.$suggest.find("li:first"),b.addClass("pillbox-suggest-sel"))}};c.fn.pillbox=function(a){var b=Array.prototype.slice.call(arguments,
1),d,e=this.each(function(){var e=c(this),f=e.data("fu.pillbox"),h="object"===typeof a&&a;f||e.data("fu.pillbox",f=new k(this,h));"string"===typeof a&&(d=f[a].apply(f,b))});return void 0===d?e:d};c.fn.pillbox.defaults={onAdd:void 0,onRemove:void 0,onKeyDown:void 0,edit:!1,readonly:-1,truncate:!1,acceptKeyCodes:[13,188],allowEmptyPills:!1};c.fn.pillbox.Constructor=k;c.fn.pillbox.noConflict=function(){c.fn.pillbox=l;return this};c(document).on("mousedown.fu.pillbox.data-api","[data-initialize=pillbox]",
function(a){a=c(a.target).closest(".pillbox");a.data("fu.pillbox")||a.pillbox(a.data())});c(function(){c("[data-initialize=pillbox]").each(function(){var a=c(this);a.data("fu.pillbox")||a.pillbox(a.data())})})});