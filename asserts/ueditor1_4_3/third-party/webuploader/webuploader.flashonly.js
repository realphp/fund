(function(n,l){var q={},e=function(d,a){var c,f,b;if("string"===typeof d)return h(d);c=[];f=d.length;for(b=0;b<f;b++)c.push(h(d[b]));return a.apply(null,c)},h=function(d){var a=q[d]||n[d];if(!a)throw Error("`"+d+"` is undefined");return a},k=l(n,function(d,a,c){2===arguments.length&&(c=a,a=null);e(a||[],function(){var a=arguments,b={exports:c};"function"===typeof c&&(a.length||(a=[e,b.exports,b]),a=c.apply(null,a),void 0!==a&&(b.exports=a));q[d]=b.exports})},e),g;(function(d){var a,c,f,b,m,r;r=function(b){return b&&
b.charAt(0).toUpperCase()+b.substr(1)};for(a in q)if(c=d,q.hasOwnProperty(a)){f=a.split("/");for(m=r(f.pop());b=r(f.shift());)c[b]=c[b]||{},c=c[b];c[m]=q[a]}})(k);"object"===typeof module&&"object"===typeof module.exports?module.exports=k:"function"===typeof define&&define.amd?define([],k):(g=n.WebUploader,n.WebUploader=k,n.WebUploader.noConflict=function(){n.WebUploader=g})})(this,function(n,l,q){l("dollar-third",[],function(){return n.jQuery||n.Zepto});l("dollar",["dollar-third"],function(e){return e});
l("promise-third",["dollar"],function(e){return{Deferred:e.Deferred,when:e.when,isPromise:function(e){return e&&"function"===typeof e.then}}});l("promise",["promise-third"],function(e){return e});l("base",["dollar","promise"],function(e,h){function k(b,a){return function(){return b.apply(a,arguments)}}function g(b){var a;if(Object.create)return Object.create(b);a=function(){};a.prototype=b;return new a}var d=function(){},a=Function.call,c=h.Deferred,f=h.isPromise,b=h.when,m=function(b){var a={},m=
b.match(/WebKit\/([\d.]+)/),c=b.match(/Chrome\/([\d.]+)/)||b.match(/CriOS\/([\d.]+)/),d=b.match(/MSIE\s([\d\.]+)/)||b.match(/(?:trident)(?:.*rv:([\w.]+))?/i),f=b.match(/Firefox\/([\d.]+)/),r=b.match(/Safari\/([\d.]+)/);b=b.match(/OPR\/([\d.]+)/);m&&(a.webkit=parseFloat(m[1]));c&&(a.chrome=parseFloat(c[1]));d&&(a.ie=parseFloat(d[1]));f&&(a.firefox=parseFloat(f[1]));r&&(a.safari=parseFloat(r[1]));b&&(a.opera=parseFloat(b[1]));return a}(navigator.userAgent),r=function(b){var a={},m=b.match(/(?:Android);?[\s\/]+([\d.]+)?/);
b=b.match(/(?:iPad|iPod|iPhone).*OS\s([\d_]+)/);m&&(a.android=parseFloat(m[1]));b&&(a.ios=parseFloat(b[1].replace(/_/g,".")));return a}(navigator.userAgent),v;v=n.console?k(console.log,console):d;return{version:"0.1.2",$:e,Deferred:c,isPromise:f,when:b,browser:m,os:r,inherits:function(b,a,m){var c;"function"===typeof a?(c=a,a=null):c=a&&a.hasOwnProperty("constructor")?a.constructor:function(){return b.apply(this,arguments)};e.extend(!0,c,b,m||{});c.__super__=b.prototype;c.prototype=g(b.prototype);
a&&e.extend(!0,c.prototype,a);return c},noop:d,bindFn:k,log:v,nextTick:function(){return function(b){setTimeout(b,1)}}(),slice:function(b){return function(){return a.apply(b,arguments)}}([].slice),guid:function(){var b=0;return function(a){for(var m=(+new Date).toString(32),c=0;5>c;c++)m+=Math.floor(65535*Math.random()).toString(32);return(a||"wu_")+m+(b++).toString(32)}}(),formatSize:function(b,a,m){var c;for(m=m||["B","K","M","G","TB"];(c=m.shift())&&1024<b;)b/=1024;return("B"===c?b:b.toFixed(a||
2))+c}}});l("mediator",["base"],function(e){function h(b,a,c,f){return d.grep(b,function(b){return b&&(!a||b.e===a)&&(!c||b.cb===c||b.cb._cb===c)&&(!f||b.ctx===f)})}function k(b,a,f){d.each((b||"").split(c),function(b,c){f(c,a)})}function g(b,a){for(var c=!1,d=-1,f=b.length,e;++d<f;)if(e=b[d],!1===e.cb.apply(e.ctx2,a)){c=!0;break}return!c}var d=e.$,a=[].slice,c=/\s+/,f;f={on:function(b,a,c){var d=this,f;if(!a)return this;f=this._events||(this._events=[]);k(b,a,function(b,a){var m={e:b};m.cb=a;m.ctx=
c;m.ctx2=c||d;m.id=f.length;f.push(m)});return this},once:function(b,a,c){var d=this;if(!a)return d;k(b,a,function(b,a){var m=function(){d.off(b,m);return a.apply(c||d,arguments)};m._cb=a;d.on(b,m,c)});return d},off:function(b,a,c){var f=this._events;if(!f)return this;if(!b&&!a&&!c)return this._events=[],this;k(b,a,function(b,a){d.each(h(f,b,a,c),function(){delete f[this.id]})});return this},trigger:function(b){var c,d,f;if(!this._events||!b)return this;c=a.call(arguments,1);d=h(this._events,b);f=
h(this._events,"all");return g(d,c)&&g(f,arguments)}};return d.extend({installTo:function(b){return d.extend(b,f)}},f)});l("uploader",["base","mediator"],function(e,h){function k(d){this.options=g.extend(!0,{},k.options,d);this._init(this.options)}var g=e.$;k.options={};h.installTo(k.prototype);g.each({upload:"start-upload",stop:"stop-upload",getFile:"get-file",getFiles:"get-files",addFile:"add-file",addFiles:"add-file",sort:"sort-files",removeFile:"remove-file",skipFile:"skip-file",retry:"retry",
isInProgress:"is-in-progress",makeThumb:"make-thumb",getDimension:"get-dimension",addButton:"add-btn",getRuntimeType:"get-runtime-type",refresh:"refresh",disable:"disable",enable:"enable",reset:"reset"},function(d,a){k.prototype[d]=function(){return this.request(a,arguments)}});g.extend(k.prototype,{state:"pending",_init:function(d){var a=this;a.request("init",d,function(){a.state="ready";a.trigger("ready")})},option:function(d,a){var c=this.options;if(1<arguments.length)g.isPlainObject(a)&&g.isPlainObject(c[d])?
g.extend(c[d],a):c[d]=a;else return d?c[d]:c},getStats:function(){var d=this.request("get-stats");return{successNum:d.numOfSuccess,cancelNum:d.numOfCancel,invalidNum:d.numOfInvalid,uploadFailNum:d.numOfUploadFailed,queueNum:d.numOfQueue}},trigger:function(d){var a=[].slice.call(arguments,1),c=this.options,f="on"+d.substring(0,1).toUpperCase()+d.substring(1);return!1===h.trigger.apply(this,arguments)||g.isFunction(c[f])&&!1===c[f].apply(this,a)||g.isFunction(this[f])&&!1===this[f].apply(this,a)||!1===
h.trigger.apply(h,[this,d].concat(a))?!1:!0},request:e.noop});e.create=k.create=function(d){return new k(d)};return e.Uploader=k});l("runtime/runtime",["base","mediator"],function(e,h){function k(a){this.options=g.extend({container:document.body},a);this.uid=e.guid("rt_")}var g=e.$,d={},a=function(a){for(var d in a)if(a.hasOwnProperty(d))return d;return null};g.extend(k.prototype,{getContainer:function(){var a,d;if(this._container)return this._container;a=g(this.options.container||document.body);
d=g(document.createElement("div"));d.attr("id","rt_"+this.uid);d.css({position:"absolute",top:"0px",left:"0px",width:"1px",height:"1px",overflow:"hidden"});a.append(d);a.addClass("webuploader-container");return this._container=d},init:e.noop,exec:e.noop,destroy:function(){this._container&&this._container.parentNode.removeChild(this.__container);this.off()}});k.orders="html5,flash";k.addRuntime=function(a,f){d[a]=f};k.hasRuntime=function(c){return!(c?!d[c]:!a(d))};k.create=function(c,f){var b;f=f||
k.orders;g.each(f.split(/\s*,\s*/g),function(){if(d[this])return b=this,!1});b=b||a(d);if(!b)throw Error("Runtime Error");return new d[b](c)};h.installTo(k.prototype);return k});l("runtime/client",["base","mediator","runtime/runtime"],function(e,h,k){function g(a,c){var f=e.Deferred(),b;this.uid=e.guid("client_");this.runtimeReady=function(b){return f.done(b)};this.connectRuntime=function(a,r){if(b)throw Error("already connected!");f.done(r);"string"===typeof a&&d.get(a)&&(b=d.get(a));(b=b||d.get(null,
c))?(e.$.extend(b.options,a),b.__promise.then(f.resolve),b.__client++):(b=k.create(a,a.runtimeOrder),b.__promise=f.promise(),b.once("ready",f.resolve),b.init(),d.add(b),b.__client=1);c&&(b.__standalone=c);return b};this.getRuntime=function(){return b};this.disconnectRuntime=function(){b&&(b.__client--,0>=b.__client&&(d.remove(b),delete b.__promise,b.destroy()),b=null)};this.exec=function(){if(b){var c=e.slice(arguments);a&&c.unshift(a);return b.exec.apply(this,c)}};this.getRuid=function(){return b&&
b.uid};this.destroy=function(b){return function(){b&&b.apply(this,arguments);this.trigger("destroy");this.off();this.exec("destroy");this.disconnectRuntime()}}(this.destroy)}var d;d=function(){var a={};return{add:function(c){a[c.uid]=c},get:function(c,d){var b;if(c)return a[c];for(b in a)if(!d||!a[b].__standalone)return a[b];return null},remove:function(c){delete a[c.uid]}}}();h.installTo(g.prototype);return g});l("lib/blob",["base","runtime/client"],function(e,h){function k(e,d){this.source=d;this.ruid=
e;h.call(this,"Blob");this.uid=d.uid||this.uid;this.type=d.type||"";this.size=d.size||0;e&&this.connectRuntime(e)}e.inherits(h,{constructor:k,slice:function(e,d){return this.exec("slice",e,d)},getSource:function(){return this.source}});return k});l("lib/file",["base","lib/blob"],function(e,h){function k(a,c){var f;h.apply(this,arguments);this.name=c.name||"untitled"+g++;f=d.exec(c.name)?RegExp.$1.toLowerCase():"";!f&&this.type&&(f=/\/(jpg|jpeg|png|gif|bmp)$/i.exec(this.type)?RegExp.$1.toLowerCase():
"",this.name+="."+f);!this.type&&~"jpg,jpeg,png,gif,bmp".indexOf(f)&&(this.type="image/"+("jpg"===f?"jpeg":f));this.ext=f;this.lastModifiedDate=c.lastModifiedDate||(new Date).toLocaleString()}var g=1,d=/\.([^.]+)$/;return e.inherits(h,k)});l("lib/filepicker",["base","runtime/client","lib/file"],function(e,h,k){function g(a){a=this.options=d.extend({},g.options,a);a.container=d(a.id);if(!a.container.length)throw Error("\u6309\u94ae\u6307\u5b9a\u9519\u8bef");a.innerHTML=a.innerHTML||a.label||a.container.html()||
"";a.button=d(a.button||document.createElement("div"));a.button.html(a.innerHTML);a.container.html(a.button);h.call(this,"FilePicker",!0)}var d=e.$;g.options={button:null,container:null,label:null,innerHTML:null,multiple:!0,accept:null,name:"file"};e.inherits(h,{constructor:g,init:function(){var a=this,c=a.options,f=c.button;f.addClass("webuploader-pick");a.on("all",function(b){switch(b){case "mouseenter":f.addClass("webuploader-pick-hover");break;case "mouseleave":f.removeClass("webuploader-pick-hover");
break;case "change":b=a.exec("getFiles"),a.trigger("select",d.map(b,function(b){b=new k(a.getRuid(),b);b._refer=c.container;return b}),c.container)}});a.connectRuntime(c,function(){a.refresh();a.exec("init",c);a.trigger("ready")});d(n).on("resize",function(){a.refresh()})},refresh:function(){var a=this.getRuntime().getContainer(),c=this.options.button,d=c.outerWidth?c.outerWidth():c.width(),b=c.outerHeight?c.outerHeight():c.height(),c=c.offset();d&&b&&a.css({bottom:"auto",right:"auto",width:d+"px",
height:b+"px"}).offset(c)},enable:function(){this.options.button.removeClass("webuploader-pick-disable");this.refresh()},disable:function(){var a=this.options.button;this.getRuntime().getContainer().css({top:"-99999px"});a.addClass("webuploader-pick-disable")},destroy:function(){this.runtime&&(this.exec("destroy"),this.disconnectRuntime())}});return g});l("widgets/widget",["base","uploader"],function(e,h){function k(b){if(!b)return!1;var a=b.length,c=d.type(b);return 1===b.nodeType&&a?!0:"array"===
c||"function"!==c&&"string"!==c&&(0===a||"number"===typeof a&&0<a&&a-1 in b)}function g(b){this.owner=b;this.options=b.options}var d=e.$,a=h.prototype._init,c={},f=[];d.extend(g.prototype,{init:e.noop,invoke:function(b,a){var f=this.responseMap;return f&&b in f&&f[b]in this&&d.isFunction(this[f[b]])?this[f[b]].apply(this,a):c},request:function(){return this.owner.request.apply(this.owner,arguments)}});d.extend(h.prototype,{_init:function(){var b=this,c=b._widgets=[];d.each(f,function(a,d){c.push(new d(b))});
return a.apply(b,arguments)},request:function(b,a,d){var f=0,g=this._widgets,h=g.length,t=[],l=[],p;for(a=k(a)?a:[a];f<h;f++)p=g[f],p=p.invoke(b,a),p!==c&&(e.isPromise(p)?l.push(p):t.push(p));return d||l.length?(b=e.when.apply(e,l),a=b.pipe?"pipe":"then",b[a](function(){var b=e.Deferred(),a=arguments;setTimeout(function(){b.resolve.apply(b,a)},1);return b.promise()})[a](d||e.noop)):t[0]}});h.register=g.register=function(b,a){var c={init:"init"};1===arguments.length?(a=b,a.responseMap=c):a.responseMap=
d.extend(c,b);c=e.inherits(g,a);f.push(c);return c};return g});l("widgets/filepicker",["base","uploader","lib/filepicker","widgets/widget"],function(e,h,k){var g=e.$;g.extend(h.options,{pick:null,accept:null});return h.register({"add-btn":"addButton",refresh:"refresh",disable:"disable",enable:"enable"},{init:function(d){this.pickers=[];return d.pick&&this.addButton(d.pick)},refresh:function(){g.each(this.pickers,function(){this.refresh()})},addButton:function(d){var a=this,c=a.options,f=c.accept,
b;if(d)return b=e.Deferred(),g.isPlainObject(d)||(d={id:d}),d=g.extend({},d,{accept:g.isPlainObject(f)?[f]:f,swf:c.swf,runtimeOrder:c.runtimeOrder}),d=new k(d),d.once("ready",b.resolve),d.on("select",function(b){a.owner.request("add-file",[b])}),d.init(),this.pickers.push(d),b.promise()},disable:function(){g.each(this.pickers,function(){this.disable()})},enable:function(){g.each(this.pickers,function(){this.enable()})}})});l("lib/image",["base","runtime/client","lib/blob"],function(e,h,k){function g(a){this.options=
d.extend({},g.options,a);h.call(this,"Image");this.on("load",function(){this._info=this.exec("info");this._meta=this.exec("meta")})}var d=e.$;g.options={quality:90,crop:!1,preserveHeaders:!0,allowMagnify:!0};e.inherits(h,{constructor:g,info:function(a){return a?(this._info=a,this):this._info},meta:function(a){return a?(this._meta=a,this):this._meta},loadFromBlob:function(a){var c=this,d=a.getRuid();this.connectRuntime(d,function(){c.exec("init",c.options);c.exec("loadFromBlob",a)})},resize:function(){var a=
e.slice(arguments);return this.exec.apply(this,["resize"].concat(a))},getAsDataUrl:function(a){return this.exec("getAsDataUrl",a)},getAsBlob:function(a){a=this.exec("getAsBlob",a);return new k(this.getRuid(),a)}});return g});l("widgets/image",["base","uploader","lib/image","widgets/widget"],function(e,h,k){var g=e.$,d;d=function(a){var c=0,d=[],b=function(){for(var b;d.length&&c<a;)b=d.shift(),c+=b[0],b[1]()};return function(a,e,g){d.push([e,g]);a.once("destroy",function(){c-=e;setTimeout(b,1)});
setTimeout(b,1)}}(5242880);g.extend(h.options,{thumb:{width:110,height:110,quality:70,allowMagnify:!0,crop:!0,preserveHeaders:!1,type:"image/jpeg"},compress:{width:1600,height:1600,quality:90,allowMagnify:!1,crop:!1,preserveHeaders:!0}});return h.register({"make-thumb":"makeThumb","before-send-file":"compressImage"},{makeThumb:function(a,c,f,b){var m,e;a=this.request("get-file",a);a.type.match(/^image/)?(m=g.extend({},this.options.thumb),g.isPlainObject(f)&&(m=g.extend(m,f),f=null),f=f||m.width,b=
b||m.height,e=new k(m),e.once("load",function(){a._info=a._info||e.info();a._meta=a._meta||e.meta();e.resize(f,b)}),e.once("complete",function(){c(!1,e.getAsDataUrl(m.type));e.destroy()}),e.once("error",function(){c(!0);e.destroy()}),d(e,a.source.size,function(){a._info&&e.info(a._info);a._meta&&e.meta(a._meta);e.loadFromBlob(a.source)})):c(!0)},compressImage:function(a){var c=this.options.compress||this.options.resize,d=c&&c.compressSize||307200,b,m;a=this.request("get-file",a);if(c&&~"image/jpeg,image/jpg".indexOf(a.type)&&
!(a.size<d)&&!a._compressed)return c=g.extend({},c),m=e.Deferred(),b=new k(c),m.always(function(){b.destroy();b=null}),b.once("error",m.reject),b.once("load",function(){a._info=a._info||b.info();a._meta=a._meta||b.meta();b.resize(c.width,c.height)}),b.once("complete",function(){var d,f;try{d=b.getAsBlob(c.type),f=a.size,d.size<f&&(a.source=d,a.size=d.size,a.trigger("resize",d.size,f)),a._compressed=!0,m.resolve()}catch(e){m.resolve()}}),a._info&&b.info(a._info),a._meta&&b.meta(a._meta),b.loadFromBlob(a.source),
m.promise()}})});l("file",["base","mediator"],function(e,h){function k(c){this.name=c.name||"Untitled";this.size=c.size||0;this.type=c.type||"application";this.lastModifiedDate=c.lastModifiedDate||1*new Date;this.id="WU_FILE_"+g++;this.ext=d.exec(this.name)?RegExp.$1:"";this.statusText="";a[this.id]=k.Status.INITED;this.source=c;this.loaded=0;this.on("error",function(a){this.setStatus(k.Status.ERROR,a)})}var g=0,d=/\.([^.]+)$/,a={};e.$.extend(k.prototype,{setStatus:function(c,d){var b=a[this.id];
"undefined"!==typeof d&&(this.statusText=d);c!==b&&(a[this.id]=c,this.trigger("statuschange",c,b))},getStatus:function(){return a[this.id]},getSource:function(){return this.source},destory:function(){delete a[this.id]}});h.installTo(k.prototype);k.Status={INITED:"inited",QUEUED:"queued",PROGRESS:"progress",ERROR:"error",COMPLETE:"complete",CANCELLED:"cancelled",INTERRUPT:"interrupt",INVALID:"invalid"};return k});l("queue",["base","mediator","file"],function(e,h,k){function g(){this.stats={numOfQueue:0,
numOfSuccess:0,numOfCancel:0,numOfProgress:0,numOfUploadFailed:0,numOfInvalid:0};this._queue=[];this._map={}}var d=e.$,a=k.Status;d.extend(g.prototype,{append:function(a){this._queue.push(a);this._fileAdded(a);return this},prepend:function(a){this._queue.unshift(a);this._fileAdded(a);return this},getFile:function(a){return"string"!==typeof a?a:this._map[a]},fetch:function(c){var d=this._queue.length,b,m;c=c||a.QUEUED;for(b=0;b<d;b++)if(m=this._queue[b],c===m.getStatus())return m;return null},sort:function(a){"function"===
typeof a&&this._queue.sort(a)},getFiles:function(){for(var a=[].slice.call(arguments,0),f=[],b=0,m=this._queue.length,e;b<m;b++)e=this._queue[b],a.length&&!~d.inArray(e.getStatus(),a)||f.push(e);return f},_fileAdded:function(c){var d=this;this._map[c.id]||(this._map[c.id]=c,c.on("statuschange",function(b,a){d._onFileStatusChange(b,a)}));c.setStatus(a.QUEUED)},_onFileStatusChange:function(c,d){var b=this.stats;switch(d){case a.PROGRESS:b.numOfProgress--;break;case a.QUEUED:b.numOfQueue--;break;case a.ERROR:b.numOfUploadFailed--;
break;case a.INVALID:b.numOfInvalid--}switch(c){case a.QUEUED:b.numOfQueue++;break;case a.PROGRESS:b.numOfProgress++;break;case a.ERROR:b.numOfUploadFailed++;break;case a.COMPLETE:b.numOfSuccess++;break;case a.CANCELLED:b.numOfCancel++;break;case a.INVALID:b.numOfInvalid++}}});h.installTo(g.prototype);return g});l("widgets/queue","base uploader queue file lib/file runtime/client widgets/widget".split(" "),function(e,h,k,g,d,a){var c=e.$,f=/\.\w+$/,b=g.Status;return h.register({"sort-files":"sortFiles",
"add-file":"addFiles","get-file":"getFile","fetch-file":"fetchFile","get-stats":"getStats","get-files":"getFiles","remove-file":"removeFile",retry:"retry",reset:"reset","accept-file":"acceptFile"},{init:function(b){var d=this,f,g,h,l,u,p,n;c.isPlainObject(b.accept)&&(b.accept=[b.accept]);if(b.accept){u=[];h=0;for(g=b.accept.length;h<g;h++)(l=b.accept[h].extensions)&&u.push(l);u.length&&(p="\\."+u.join(",").replace(/,/g,"$|\\.").replace(/\*/g,".*")+"$");d.accept=new RegExp(p,"i")}d.queue=new k;d.stats=
d.queue.stats;if("html5"===this.request("predict-runtime-type"))return f=e.Deferred(),n=new a("Placeholder"),n.connectRuntime({runtimeOrder:"html5"},function(){d._ruid=n.getRuid();f.resolve()}),f.promise()},_wrapFile:function(b){if(!(b instanceof g)){if(!(b instanceof d)){if(!this._ruid)throw Error("Can't add external files.");b=new d(this._ruid,b)}b=new g(b)}return b},acceptFile:function(b){return!(!b||6>b.size||this.accept&&f.exec(b.name)&&!this.accept.test(b.name))},_addFile:function(b){b=this._wrapFile(b);
if(this.owner.trigger("beforeFileQueued",b)){if(this.acceptFile(b))return this.queue.append(b),this.owner.trigger("fileQueued",b),b;this.owner.trigger("error","Q_TYPE_DENIED",b)}},getFile:function(b){return this.queue.getFile(b)},addFiles:function(b){var a=this;b.length||(b=[b]);b=c.map(b,function(b){return a._addFile(b)});a.owner.trigger("filesQueued",b);a.options.auto&&a.request("start-upload")},getStats:function(){return this.stats},removeFile:function(a){a=a.id?a:this.queue.getFile(a);a.setStatus(b.CANCELLED);
this.owner.trigger("fileDequeued",a)},getFiles:function(){return this.queue.getFiles.apply(this.queue,arguments)},fetchFile:function(){return this.queue.fetch.apply(this.queue,arguments)},retry:function(a,c){var d,f,e;if(a)a=a.id?a:this.queue.getFile(a),a.setStatus(b.QUEUED),c||this.request("start-upload");else{d=this.queue.getFiles(b.ERROR);f=0;for(e=d.length;f<e;f++)a=d[f],a.setStatus(b.QUEUED);this.request("start-upload")}},sortFiles:function(){return this.queue.sort.apply(this.queue,arguments)},
reset:function(){this.queue=new k;this.stats=this.queue.stats}})});l("widgets/runtime",["uploader","runtime/runtime","widgets/widget"],function(e,h){e.support=function(){return h.hasRuntime.apply(h,arguments)};return e.register({"predict-runtime-type":"predictRuntmeType"},{init:function(){if(!this.predictRuntmeType())throw Error("Runtime Error");},predictRuntmeType:function(){var e=this.options.runtimeOrder||h.orders,g=this.type,d,a;if(!g)for(e=e.split(/\s*,\s*/g),d=0,a=e.length;d<a;d++)if(h.hasRuntime(e[d])){this.type=
g=e[d];break}return g}})});l("lib/transport",["base","runtime/client","mediator"],function(e,h,k){function g(a){var c=this;a=c.options=d.extend(!0,{},g.options,a||{});h.call(this,"Transport");this._blob=null;this._formData=a.formData||{};this._headers=a.headers||{};this.on("progress",this._timeout);this.on("load error",function(){c.trigger("progress",1);clearTimeout(c._timer)})}var d=e.$;g.options={server:"",method:"POST",withCredentials:!1,fileVal:"file",timeout:12E4,formData:{},headers:{},sendAsBinary:!1};
d.extend(g.prototype,{appendBlob:function(a,c,d){var b=this,e=b.options;b.getRuid()&&b.disconnectRuntime();b.connectRuntime(c.ruid,function(){b.exec("init")});b._blob=c;e.fileVal=a||e.fileVal;e.filename=d||e.filename},append:function(a,c){"object"===typeof a?d.extend(this._formData,a):this._formData[a]=c},setRequestHeader:function(a,c){"object"===typeof a?d.extend(this._headers,a):this._headers[a]=c},send:function(a){this.exec("send",a);this._timeout()},abort:function(){clearTimeout(this._timer);
return this.exec("abort")},destroy:function(){this.trigger("destroy");this.off();this.exec("destroy");this.disconnectRuntime()},getResponse:function(){return this.exec("getResponse")},getResponseAsJson:function(){return this.exec("getResponseAsJson")},getStatus:function(){return this.exec("getStatus")},_timeout:function(){var a=this,c=a.options.timeout;c&&(clearTimeout(a._timer),a._timer=setTimeout(function(){a.abort();a.trigger("error","timeout")},c))}});k.installTo(g.prototype);return g});l("widgets/upload",
["base","uploader","file","lib/transport","widgets/widget"],function(e,h,k,g){function d(b,a){for(var c=[],d=b.source.size,e=a?Math.ceil(d/a):1,f=0,g=0,h;g<e;)h=Math.min(a,d-f),c.push({file:b,start:f,end:a?f+h:d,total:d,chunks:e,chunk:g++}),f+=h;b.blocks=c.concat();b.remaning=c.length;return{file:b,has:function(){return!!c.length},fetch:function(){return c.shift()}}}var a=e.$,c=e.isPromise,f=k.Status;a.extend(h.options,{prepareNextFile:!1,chunked:!1,chunkSize:5242880,chunkRetry:2,threads:3,formData:null});
h.register({"start-upload":"start","stop-upload":"stop","skip-file":"skipFile","is-in-progress":"isInProgress"},{init:function(){var b=this.owner;this.runing=!1;this.pool=[];this.pending=[];this.remaning=0;this.__tick=e.bindFn(this._tick,this);b.on("uploadComplete",function(b){b.blocks&&a.each(b.blocks,function(b,a){a.transport&&(a.transport.abort(),a.transport.destroy());delete a.transport});delete b.blocks;delete b.remaning})},start:function(){var b=this;a.each(b.request("get-files",f.INVALID),
function(){b.request("remove-file",this)});b.runing||(b.runing=!0,a.each(b.pool,function(a,c){var d=c.file;d.getStatus()===f.INTERRUPT&&(d.setStatus(f.PROGRESS),b._trigged=!1,c.transport&&c.transport.send())}),b._trigged=!1,b.owner.trigger("startUpload"),e.nextTick(b.__tick))},stop:function(b){!1!==this.runing&&(this.runing=!1,b&&a.each(this.pool,function(b,a){a.transport&&a.transport.abort();a.file.setStatus(f.INTERRUPT)}),this.owner.trigger("stopUpload"))},isInProgress:function(){return!!this.runing},
getStats:function(){return this.request("get-stats")},skipFile:function(b,c){b=this.request("get-file",b);b.setStatus(c||f.COMPLETE);b.skipped=!0;b.blocks&&a.each(b.blocks,function(b,a){var c=a.transport;c&&(c.abort(),c.destroy(),delete a.transport)});this.owner.trigger("uploadSkip",b)},_tick:function(){var b=this,a=b.options,d;if(b._promise)return b._promise.always(b.__tick);b.pool.length<a.threads&&(d=b._nextBlock())?(b._trigged=!1,a=function(a){b._promise=null;a&&a.file&&b._startSend(a);e.nextTick(b.__tick)},
b._promise=c(d)?d.always(a):a(d)):b.remaning||b.getStats().numOfQueue||(b.runing=!1,b._trigged||e.nextTick(function(){b.owner.trigger("uploadFinished")}),b._trigged=!0)},_nextBlock:function(){var b=this,a=b._act,e=b.options,g,h;if(a&&a.has()&&a.file.getStatus()===f.PROGRESS)return e.prepareNextFile&&!b.pending.length&&b._prepareNextFile(),a.fetch();if(b.runing)return!b.pending.length&&b.getStats().numOfQueue&&b._prepareNextFile(),g=b.pending.shift(),h=function(c){if(!c)return null;a=d(c,e.chunked?
e.chunkSize:0);b._act=a;return a.fetch()},c(g)?g[g.pipe?"pipe":"then"](h):h(g)},_prepareNextFile:function(){var b=this,c=b.request("fetch-file"),d=b.pending,e;c&&(e=b.request("before-send-file",c,function(){return c.getStatus()===f.QUEUED?(b.owner.trigger("uploadStart",c),c.setStatus(f.PROGRESS),c):b._finishFile(c)}),e.done(function(){var b=a.inArray(e,d);~b&&d.splice(b,1,c)}),e.fail(function(a){c.setStatus(f.ERROR,a);b.owner.trigger("uploadError",c,a);b.owner.trigger("uploadComplete",c)}),d.push(e))},
_popBlock:function(b){var c=a.inArray(b,this.pool);this.pool.splice(c,1);b.file.remaning--;this.remaning--},_startSend:function(a){var c=this,d=a.file;c.pool.push(a);c.remaning++;a.blob=1===a.chunks?d.source:d.source.slice(a.start,a.end);c.request("before-send",a,function(){d.getStatus()===f.PROGRESS?c._doSend(a):(c._popBlock(a),e.nextTick(c.__tick))}).fail(function(){1===d.remaning?c._finishFile(d).always(function(){a.percentage=1;c._popBlock(a);c.owner.trigger("uploadComplete",d);e.nextTick(c.__tick)}):
(a.percentage=1,c._popBlock(a),e.nextTick(c.__tick))})},_doSend:function(b){var c=this,d=c.owner,h=c.options,k=b.file,l=new g(h),t=a.extend({},h.formData),n=a.extend({},h.headers),p,q;b.transport=l;l.on("destroy",function(){delete b.transport;c._popBlock(b);e.nextTick(c.__tick)});l.on("progress",function(c){var e=0,f=0,e=b.percentage=c;1<b.chunks&&(a.each(k.blocks,function(a,b){f+=(b.percentage||0)*(b.end-b.start)}),e=f/k.size);d.trigger("uploadProgress",k,e||0)});p=function(a){q=l.getResponseAsJson()||
{};q._raw=l.getResponse();d.trigger("uploadAccept",b,q,function(b){a=b})||(a=a||"server");return a};l.on("error",function(a,c){b.retried=b.retried||0;1<b.chunks&&~"http,abort".indexOf(a)&&b.retried<h.chunkRetry?(b.retried++,l.send()):(c||"server"!==a||(a=p(a)),k.setStatus(f.ERROR,a),d.trigger("uploadError",k,a),d.trigger("uploadComplete",k))});l.on("load",function(){var a;(a=p())?l.trigger("error",a,!0):1===k.remaning?c._finishFile(k,q):l.destroy()});t=a.extend(t,{id:k.id,name:k.name,type:k.type,
lastModifiedDate:k.lastModifiedDate,size:k.size});1<b.chunks&&a.extend(t,{chunks:b.chunks,chunk:b.chunk});d.trigger("uploadBeforeSend",b,t,n);l.appendBlob(h.fileVal,b.blob,k.name);l.append(t);l.setRequestHeader(n);l.send()},_finishFile:function(a,c,d){var e=this.owner;return e.request("after-send-file",arguments,function(){a.setStatus(f.COMPLETE);e.trigger("uploadSuccess",a,c,d)}).fail(function(c){a.getStatus()===f.PROGRESS&&a.setStatus(f.ERROR,c);e.trigger("uploadError",a,c)}).always(function(){e.trigger("uploadComplete",
a)})}})});l("widgets/validator",["base","uploader","file","widgets/widget"],function(e,h,k){var g=e.$,d={};e={addValidator:function(a,c){d[a]=c},removeValidator:function(a){delete d[a]}};h.register({init:function(){var a=this;g.each(d,function(){this.call(a.owner)})}});e.addValidator("fileNumLimit",function(){var a=0,c=this.options.fileNumLimit>>0,d=!0;c&&(this.on("beforeFileQueued",function(b){a>=c&&d&&(d=!1,this.trigger("error","Q_EXCEED_NUM_LIMIT",c,b),setTimeout(function(){d=!0},1));return a>=
c?!1:!0}),this.on("fileQueued",function(){a++}),this.on("fileDequeued",function(){a--}),this.on("uploadFinished",function(){a=0}))});e.addValidator("fileSizeLimit",function(){var a=0,c=this.options.fileSizeLimit>>0,d=!0;c&&(this.on("beforeFileQueued",function(b){var e=a+b.size>c;e&&d&&(d=!1,this.trigger("error","Q_EXCEED_SIZE_LIMIT",c,b),setTimeout(function(){d=!0},1));return e?!1:!0}),this.on("fileQueued",function(b){a+=b.size}),this.on("fileDequeued",function(b){a-=b.size}),this.on("uploadFinished",
function(){a=0}))});e.addValidator("fileSingleSizeLimit",function(){var a=this.options.fileSingleSizeLimit;if(a)this.on("beforeFileQueued",function(c){if(c.size>a)return c.setStatus(k.Status.INVALID,"exceed_size"),this.trigger("error","F_EXCEED_SIZE",c),!1})});e.addValidator("duplicate",function(){var a={};this.options.duplicate||(this.on("beforeFileQueued",function(c){var d;if(!(d=c.__hash)){d=c.name+c.size+c.lastModifiedDate;for(var b=0,e=0,g=d.length,h;e<g;e++)h=d.charCodeAt(e),b=h+(b<<6)+(b<<
16)-b;d=c.__hash=b}if(a[d])return this.trigger("error","F_DUPLICATE",c),!1}),this.on("fileQueued",function(c){(c=c.__hash)&&(a[c]=!0)}),this.on("fileDequeued",function(c){(c=c.__hash)&&delete a[c]}))});return e});l("runtime/compbase",[],function(){return function(e,h){this.owner=e;this.options=e.options;this.getRuntime=function(){return h};this.getRuid=function(){return h.uid};this.trigger=function(){return e.trigger.apply(e,arguments)}}});l("runtime/flash/runtime",["base","runtime/runtime","runtime/compbase"],
function(e,h,k){function g(){function c(a,c){var d=a.type||a,e,d=d.split("::");e=d[0];d=d[1];"Ready"===d&&e===k.uid?k.trigger("ready"):b[e]&&b[e].trigger(d.toLowerCase(),a,c)}var d={},b={},g=this.destory,k=this,l=e.guid("webuploader_");h.apply(k,arguments);k.type="flash";k.exec=function(c,g){var h=this.uid,l=e.slice(arguments,2);b[h]=this;return a[c]&&(d[h]||(d[h]=new a[c](this,k)),h=d[h],h[g])?h[g].apply(h,l):k.flashExec.apply(this,arguments)};n[l]=function(){var a=arguments;setTimeout(function(){c.apply(null,
a)},1)};this.jsreciver=l;this.destory=function(){return g&&g.apply(this,arguments)};this.flashExec=function(a,b){var c=k.getFlash(),d=e.slice(arguments,2);return c.exec(this.uid,a,b,d)}}var d=e.$,a={};e.inherits(h,{constructor:g,init:function(){var a=this.getContainer(),d=this.options,b;a.css({position:"absolute",top:"-8px",left:"-8px",width:"9px",height:"9px",overflow:"hidden"});b='<object id="'+this.uid+'" type="application/x-shockwave-flash" data="'+d.swf+'" ';e.browser.ie&&(b+='classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" ');
b+='width="100%" height="100%" style="outline:0"><param name="movie" value="'+d.swf+'" /><param name="flashvars" value="uid='+this.uid+"&jsreciver="+this.jsreciver+'" /><param name="wmode" value="transparent" /><param name="allowscriptaccess" value="always" /></object>';a.html(b)},getFlash:function(){return this._flash?this._flash:this._flash=d("#"+this.uid).get(0)}});g.register=function(c,f){return f=a[c]=e.inherits(k,d.extend({flashExec:function(){var a=this.owner;return this.getRuntime().flashExec.apply(a,
arguments)}},f))};11.4<=function(){var a;try{a=navigator.plugins["Shockwave Flash"],a=a.description}catch(d){try{a=(new ActiveXObject("ShockwaveFlash.ShockwaveFlash")).GetVariable("$version")}catch(b){a="0.0"}}a=a.match(/\d+/g);return parseFloat(a[0]+"."+a[1],10)}()&&h.addRuntime("flash",g);return g});l("runtime/flash/filepicker",["base","runtime/flash/runtime"],function(e,h){var k=e.$;return h.register("FilePicker",{init:function(e){e=k.extend({},e);var d,a;d=e.accept&&e.accept.length;for(a=0;a<
d;a++)e.accept[a].title||(e.accept[a].title="Files");delete e.button;delete e.container;this.flashExec("FilePicker","init",e)},destroy:function(){}})});l("runtime/flash/image",["runtime/flash/runtime"],function(e){return e.register("Image",{loadFromBlob:function(e){var k=this.owner;k.info()&&this.flashExec("Image","info",k.info());k.meta()&&this.flashExec("Image","meta",k.meta());this.flashExec("Image","loadFromBlob",e.uid)}})});l("runtime/flash/transport",["base","runtime/flash/runtime","runtime/client"],
function(e,h,k){var g=e.$;return h.register("Transport",{init:function(){this._status=0;this._responseJson=this._response=null},send:function(){var d=this.owner,a=this.options,c=this._initAjax(),e=d._blob,b=a.server,h;c.connectRuntime(e.ruid);a.sendAsBinary?(b+=(/\?/.test(b)?"&":"?")+g.param(d._formData),h=e.uid):(g.each(d._formData,function(a,b){c.exec("append",a,b)}),c.exec("appendBlob",a.fileVal,e.uid,a.filename||d._formData.name||""));this._setRequestHeader(c,a.headers);c.exec("send",{method:a.method,
url:b},h)},getStatus:function(){return this._status},getResponse:function(){return this._response},getResponseAsJson:function(){return this._responseJson},abort:function(){var d=this._xhr;d&&(d.exec("abort"),d.destroy(),this._xhr=null)},destroy:function(){this.abort()},_initAjax:function(){var d=this,a=new k("XMLHttpRequest");a.on("uploadprogress progress",function(a){return d.trigger("progress",a.loaded/a.total)});a.on("load",function(){var c=a.exec("getStatus"),e="";a.off();d._xhr=null;200<=c&&
300>c?(d._response=a.exec("getResponse"),d._responseJson=a.exec("getResponseAsJson")):500<=c&&600>c?(d._response=a.exec("getResponse"),d._responseJson=a.exec("getResponseAsJson"),e="server"):e="http";a.destroy();a=null;return e?d.trigger("error",e):d.trigger("load")});a.on("error",function(){a.off();d._xhr=null;d.trigger("error","http")});return d._xhr=a},_setRequestHeader:function(d,a){g.each(a,function(a,e){d.exec("setRequestHeader",a,e)})}})});l("preset/flashonly","base widgets/filepicker widgets/image widgets/queue widgets/runtime widgets/upload widgets/validator runtime/flash/filepicker runtime/flash/image runtime/flash/transport".split(" "),
function(e){return e});l("webuploader",["preset/flashonly"],function(e){return e});return q("webuploader")});