!function(r,m){var v,f={},h=function(e,c){var a,d,b;if("string"==typeof e)return k(e);a=[];d=e.length;for(b=0;d>b;b++)a.push(k(e[b]));return c.apply(null,a)},k=function(e){var c=f[e]||r[e];if(!c)throw Error("`"+e+"` is undefined");return c},g=m(r,function(e,c,a){2===arguments.length&&(a=c,c=null);h(c||[],function(){var d=arguments,b,l={exports:a};"function"==typeof a&&(d.length||(d=[h,l.exports,l]),b=a.apply(null,d),void 0!==b&&(l.exports=b));f[e]=l.exports})},h);(function(e){var c,a,d,b,l,n;n=function(b){return b&&
b.charAt(0).toUpperCase()+b.substr(1)};for(c in f)if(a=e,f.hasOwnProperty(c)){d=c.split("/");for(l=n(d.pop());b=n(d.shift());)a[b]=a[b]||{},a=a[b];a[l]=f[c]}})(g);"object"==typeof module&&"object"==typeof module.exports?module.exports=g:"function"==typeof define&&define.amd?define([],g):(v=r.WebUploader,r.WebUploader=g,r.WebUploader.noConflict=function(){r.WebUploader=v})}(this,function(r,m,v){return m("dollar-third",[],function(){return r.jQuery||r.Zepto}),m("dollar",["dollar-third"],function(f){return f}),
m("promise-third",["dollar"],function(f){return{Deferred:f.Deferred,when:f.when,isPromise:function(f){return f&&"function"==typeof f.then}}}),m("promise",["promise-third"],function(f){return f}),m("base",["dollar","promise"],function(f,h){function k(a,d){return function(){return a.apply(d,arguments)}}function g(a){var d;return Object.create?Object.create(a):(d=function(){},d.prototype=a,new d)}var e=function(){},c=Function.call;return{version:"0.1.2",$:f,Deferred:h.Deferred,isPromise:h.isPromise,
when:h.when,browser:function(a){var d={},b=a.match(/WebKit\/([\d.]+)/),l=a.match(/Chrome\/([\d.]+)/)||a.match(/CriOS\/([\d.]+)/),c=a.match(/MSIE\s([\d\.]+)/)||a.match(/(?:trident)(?:.*rv:([\w.]+))?/i),e=a.match(/Firefox\/([\d.]+)/),f=a.match(/Safari\/([\d.]+)/);a=a.match(/OPR\/([\d.]+)/);return b&&(d.webkit=parseFloat(b[1])),l&&(d.chrome=parseFloat(l[1])),c&&(d.ie=parseFloat(c[1])),e&&(d.firefox=parseFloat(e[1])),f&&(d.safari=parseFloat(f[1])),a&&(d.opera=parseFloat(a[1])),d}(navigator.userAgent),
os:function(a){var d={},b=a.match(/(?:Android);?[\s\/]+([\d.]+)?/);a=a.match(/(?:iPad|iPod|iPhone).*OS\s([\d_]+)/);return b&&(d.android=parseFloat(b[1])),a&&(d.ios=parseFloat(a[1].replace(/_/g,"."))),d}(navigator.userAgent),inherits:function(a,d,b){var l;return"function"==typeof d?(l=d,d=null):l=d&&d.hasOwnProperty("constructor")?d.constructor:function(){return a.apply(this,arguments)},f.extend(!0,l,a,b||{}),l.__super__=a.prototype,l.prototype=g(a.prototype),d&&f.extend(!0,l.prototype,d),l},noop:e,
bindFn:k,log:r.console?k(console.log,console):e,nextTick:function(){return function(a){setTimeout(a,1)}}(),slice:function(a){return function(){return c.apply(a,arguments)}}([].slice),guid:function(){var a=0;return function(d){for(var b=(+new Date).toString(32),l=0;5>l;l++)b+=Math.floor(65535*Math.random()).toString(32);return(d||"wu_")+b+(a++).toString(32)}}(),formatSize:function(a,d,b){var l;for(b=b||["B","K","M","G","TB"];(l=b.shift())&&1024<a;)a/=1024;return("B"===l?a:a.toFixed(d||2))+l}}}),m("mediator",
["base"],function(f){function h(b,l,a,d){return c.grep(b,function(b){return!(!b||l&&b.e!==l||a&&b.cb!==a&&b.cb._cb!==a||d&&b.ctx!==d)})}function k(b,a,n){c.each((b||"").split(d),function(b,d){n(d,a)})}function g(b,a){for(var d,c=!1,e=-1,f=b.length;++e<f;)if(d=b[e],!1===d.cb.apply(d.ctx2,a)){c=!0;break}return!c}var e,c=f.$,a=[].slice,d=/\s+/;return e={on:function(b,a,d){var c,e=this;return a?(c=this._events||(this._events=[]),k(b,a,function(b,a){var l={e:b};l.cb=a;l.ctx=d;l.ctx2=d||e;l.id=c.length;
c.push(l)}),this):this},once:function(b,a,d){var c=this;return a?(k(b,a,function(b,a){var l=function(){return c.off(b,l),a.apply(d||c,arguments)};l._cb=a;c.on(b,l,d)}),c):c},off:function(b,a,d){var e=this._events;return e?b||a||d?(k(b,a,function(b,a){c.each(h(e,b,a,d),function(){delete e[this.id]})}),this):(this._events=[],this):this},trigger:function(b){var d,c,e;return this._events&&b?(d=a.call(arguments,1),c=h(this._events,b),e=h(this._events,"all"),g(c,d)&&g(e,arguments)):this}},c.extend({installTo:function(b){return c.extend(b,
e)}},e)}),m("uploader",["base","mediator"],function(f,h){function k(e){this.options=g.extend(!0,{},k.options,e);this._init(this.options)}var g=f.$;return k.options={},h.installTo(k.prototype),g.each({upload:"start-upload",stop:"stop-upload",getFile:"get-file",getFiles:"get-files",addFile:"add-file",addFiles:"add-file",sort:"sort-files",removeFile:"remove-file",skipFile:"skip-file",retry:"retry",isInProgress:"is-in-progress",makeThumb:"make-thumb",getDimension:"get-dimension",addButton:"add-btn",getRuntimeType:"get-runtime-type",
refresh:"refresh",disable:"disable",enable:"enable",reset:"reset"},function(e,c){k.prototype[e]=function(){return this.request(c,arguments)}}),g.extend(k.prototype,{state:"pending",_init:function(e){var c=this;c.request("init",e,function(){c.state="ready";c.trigger("ready")})},option:function(e,c){var a=this.options;return 1<arguments.length?void(g.isPlainObject(c)&&g.isPlainObject(a[e])?g.extend(a[e],c):a[e]=c):e?a[e]:a},getStats:function(){var e=this.request("get-stats");return{successNum:e.numOfSuccess,
cancelNum:e.numOfCancel,invalidNum:e.numOfInvalid,uploadFailNum:e.numOfUploadFailed,queueNum:e.numOfQueue}},trigger:function(e){var c=[].slice.call(arguments,1),a=this.options,d="on"+e.substring(0,1).toUpperCase()+e.substring(1);return!1===h.trigger.apply(this,arguments)||g.isFunction(a[d])&&!1===a[d].apply(this,c)||g.isFunction(this[d])&&!1===this[d].apply(this,c)||!1===h.trigger.apply(h,[this,e].concat(c))?!1:!0},request:f.noop}),f.create=k.create=function(e){return new k(e)},f.Uploader=k,k}),m("runtime/runtime",
["base","mediator"],function(f,h){function k(a){this.options=g.extend({container:document.body},a);this.uid=f.guid("rt_")}var g=f.$,e={},c=function(a){for(var d in a)if(a.hasOwnProperty(d))return d;return null};return g.extend(k.prototype,{getContainer:function(){var a,d,b=this.options;return this._container?this._container:(a=g(b.container||document.body),d=g(document.createElement("div")),d.attr("id","rt_"+this.uid),d.css({position:"absolute",top:"0px",left:"0px",width:"1px",height:"1px",overflow:"hidden"}),
a.append(d),a.addClass("webuploader-container"),this._container=d,d)},init:f.noop,exec:f.noop,destroy:function(){this._container&&this._container.parentNode.removeChild(this.__container);this.off()}}),k.orders="html5,flash",k.addRuntime=function(a,d){e[a]=d},k.hasRuntime=function(a){return!(a?!e[a]:!c(e))},k.create=function(a,d){var b;if(d=d||k.orders,g.each(d.split(/\s*,\s*/g),function(){return e[this]?(b=this,!1):void 0}),b=b||c(e),!b)throw Error("Runtime Error");return new e[b](a)},h.installTo(k.prototype),
k}),m("runtime/client",["base","mediator","runtime/runtime"],function(f,h,k){function g(c,a){var d,b=f.Deferred();this.uid=f.guid("client_");this.runtimeReady=function(a){return b.done(a)};this.connectRuntime=function(c,n){if(d)throw Error("already connected!");return b.done(n),"string"==typeof c&&e.get(c)&&(d=e.get(c)),d=d||e.get(null,a),d?(f.$.extend(d.options,c),d.__promise.then(b.resolve),d.__client++):(d=k.create(c,c.runtimeOrder),d.__promise=b.promise(),d.once("ready",b.resolve),d.init(),e.add(d),
d.__client=1),a&&(d.__standalone=a),d};this.getRuntime=function(){return d};this.disconnectRuntime=function(){d&&(d.__client--,0>=d.__client&&(e.remove(d),delete d.__promise,d.destroy()),d=null)};this.exec=function(){if(d){var b=f.slice(arguments);return c&&b.unshift(c),d.exec.apply(this,b)}};this.getRuid=function(){return d&&d.uid};this.destroy=function(b){return function(){b&&b.apply(this,arguments);this.trigger("destroy");this.off();this.exec("destroy");this.disconnectRuntime()}}(this.destroy)}
var e;return e=function(){var c={};return{add:function(a){c[a.uid]=a},get:function(a,d){var b;if(a)return c[a];for(b in c)if(!d||!c[b].__standalone)return c[b];return null},remove:function(a){delete c[a.uid]}}}(),h.installTo(g.prototype),g}),m("lib/blob",["base","runtime/client"],function(f,h){function k(f,e){this.source=e;this.ruid=f;h.call(this,"Blob");this.uid=e.uid||this.uid;this.type=e.type||"";this.size=e.size||0;f&&this.connectRuntime(f)}return f.inherits(h,{constructor:k,slice:function(f,
e){return this.exec("slice",f,e)},getSource:function(){return this.source}}),k}),m("lib/file",["base","lib/blob"],function(f,h){function k(c,a){var d;h.apply(this,arguments);this.name=a.name||"untitled"+g++;d=e.exec(a.name)?RegExp.$1.toLowerCase():"";!d&&this.type&&(d=/\/(jpg|jpeg|png|gif|bmp)$/i.exec(this.type)?RegExp.$1.toLowerCase():"",this.name+="."+d);!this.type&&~"jpg,jpeg,png,gif,bmp".indexOf(d)&&(this.type="image/"+("jpg"===d?"jpeg":d));this.ext=d;this.lastModifiedDate=a.lastModifiedDate||
(new Date).toLocaleString()}var g=1,e=/\.([^.]+)$/;return f.inherits(h,k)}),m("lib/filepicker",["base","runtime/client","lib/file"],function(f,h,k){function g(c){if(c=this.options=e.extend({},g.options,c),c.container=e(c.id),!c.container.length)throw Error("\u6309\u94ae\u6307\u5b9a\u9519\u8bef");c.innerHTML=c.innerHTML||c.label||c.container.html()||"";c.button=e(c.button||document.createElement("div"));c.button.html(c.innerHTML);c.container.html(c.button);h.call(this,"FilePicker",!0)}var e=f.$;return g.options=
{button:null,container:null,label:null,innerHTML:null,multiple:!0,accept:null,name:"file"},f.inherits(h,{constructor:g,init:function(){var c=this,a=c.options,d=a.button;d.addClass("webuploader-pick");c.on("all",function(b){switch(b){case "mouseenter":d.addClass("webuploader-pick-hover");break;case "mouseleave":d.removeClass("webuploader-pick-hover");break;case "change":b=c.exec("getFiles"),c.trigger("select",e.map(b,function(b){return b=new k(c.getRuid(),b),b._refer=a.container,b}),a.container)}});
c.connectRuntime(a,function(){c.refresh();c.exec("init",a);c.trigger("ready")});e(r).on("resize",function(){c.refresh()})},refresh:function(){var c=this.getRuntime().getContainer(),a=this.options.button,d=a.outerWidth?a.outerWidth():a.width(),b=a.outerHeight?a.outerHeight():a.height(),a=a.offset();d&&b&&c.css({bottom:"auto",right:"auto",width:d+"px",height:b+"px"}).offset(a)},enable:function(){this.options.button.removeClass("webuploader-pick-disable");this.refresh()},disable:function(){var c=this.options.button;
this.getRuntime().getContainer().css({top:"-99999px"});c.addClass("webuploader-pick-disable")},destroy:function(){this.runtime&&(this.exec("destroy"),this.disconnectRuntime())}}),g}),m("widgets/widget",["base","uploader"],function(f,h){function k(b){if(!b)return!1;var a=b.length,d=e.type(b);return 1===b.nodeType&&a?!0:"array"===d||"function"!==d&&"string"!==d&&(0===a||"number"==typeof a&&0<a&&a-1 in b)}function g(b){this.owner=b;this.options=b.options}var e=f.$,c=h.prototype._init,a={},d=[];return e.extend(g.prototype,
{init:f.noop,invoke:function(b,d){var c=this.responseMap;return c&&b in c&&c[b]in this&&e.isFunction(this[c[b]])?this[c[b]].apply(this,d):a},request:function(){return this.owner.request.apply(this.owner,arguments)}}),e.extend(h.prototype,{_init:function(){var b=this,a=b._widgets=[];return e.each(d,function(d,c){a.push(new c(b))}),c.apply(b,arguments)},request:function(b,d,c){var e,g,h,p=0,q=this._widgets,m=q.length,t=[],w=[];for(d=k(d)?d:[d];m>p;p++)e=q[p],e=e.invoke(b,d),e!==a&&(f.isPromise(e)?w.push(e):
t.push(e));return c||w.length?(g=f.when.apply(f,w),h=g.pipe?"pipe":"then",g[h](function(){var b=f.Deferred(),a=arguments;return setTimeout(function(){b.resolve.apply(b,a)},1),b.promise()})[h](c||f.noop)):t[0]}}),h.register=g.register=function(b,a){var c,k={init:"init"};return 1===arguments.length?(a=b,a.responseMap=k):a.responseMap=e.extend(k,b),c=f.inherits(g,a),d.push(c),c},g}),m("widgets/filepicker",["base","uploader","lib/filepicker","widgets/widget"],function(f,h,k){var g=f.$;return g.extend(h.options,
{pick:null,accept:null}),h.register({"add-btn":"addButton",refresh:"refresh",disable:"disable",enable:"enable"},{init:function(e){return this.pickers=[],e.pick&&this.addButton(e.pick)},refresh:function(){g.each(this.pickers,function(){this.refresh()})},addButton:function(e){var c,a,d,b=this,l=b.options,n=l.accept;if(e)return d=f.Deferred(),g.isPlainObject(e)||(e={id:e}),c=g.extend({},e,{accept:g.isPlainObject(n)?[n]:n,swf:l.swf,runtimeOrder:l.runtimeOrder}),a=new k(c),a.once("ready",d.resolve),a.on("select",
function(a){b.owner.request("add-file",[a])}),a.init(),this.pickers.push(a),d.promise()},disable:function(){g.each(this.pickers,function(){this.disable()})},enable:function(){g.each(this.pickers,function(){this.enable()})}})}),m("lib/image",["base","runtime/client","lib/blob"],function(f,h,k){function g(c){this.options=e.extend({},g.options,c);h.call(this,"Image");this.on("load",function(){this._info=this.exec("info");this._meta=this.exec("meta")})}var e=f.$;return g.options={quality:90,crop:!1,preserveHeaders:!0,
allowMagnify:!0},f.inherits(h,{constructor:g,info:function(c){return c?(this._info=c,this):this._info},meta:function(c){return c?(this._meta=c,this):this._meta},loadFromBlob:function(c){var a=this,d=c.getRuid();this.connectRuntime(d,function(){a.exec("init",a.options);a.exec("loadFromBlob",c)})},resize:function(){var c=f.slice(arguments);return this.exec.apply(this,["resize"].concat(c))},getAsDataUrl:function(c){return this.exec("getAsDataUrl",c)},getAsBlob:function(c){c=this.exec("getAsBlob",c);
return new k(this.getRuid(),c)}}),g}),m("widgets/image",["base","uploader","lib/image","widgets/widget"],function(f,h,k){var g,e=f.$;return g=function(c){var a=0,d=[],b=function(){for(var b;d.length&&c>a;)b=d.shift(),a+=b[0],b[1]()};return function(c,e,f){d.push([e,f]);c.once("destroy",function(){a-=e;setTimeout(b,1)});setTimeout(b,1)}}(5242880),e.extend(h.options,{thumb:{width:110,height:110,quality:70,allowMagnify:!0,crop:!0,preserveHeaders:!1,type:"image/jpeg"},compress:{width:1600,height:1600,
quality:90,allowMagnify:!1,crop:!1,preserveHeaders:!0}}),h.register({"make-thumb":"makeThumb","before-send-file":"compressImage"},{makeThumb:function(c,a,d,b){var l,n;return c=this.request("get-file",c),c.type.match(/^image/)?(l=e.extend({},this.options.thumb),e.isPlainObject(d)&&(l=e.extend(l,d),d=null),d=d||l.width,b=b||l.height,n=new k(l),n.once("load",function(){c._info=c._info||n.info();c._meta=c._meta||n.meta();n.resize(d,b)}),n.once("complete",function(){a(!1,n.getAsDataUrl(l.type));n.destroy()}),
n.once("error",function(){a(!0);n.destroy()}),void g(n,c.source.size,function(){c._info&&n.info(c._info);c._meta&&n.meta(c._meta);n.loadFromBlob(c.source)})):void a(!0)},compressImage:function(c){var a,d,b=this.options.compress||this.options.resize,l=b&&b.compressSize||307200;return c=this.request("get-file",c),!b||!~"image/jpeg,image/jpg".indexOf(c.type)||c.size<l||c._compressed?void 0:(b=e.extend({},b),d=f.Deferred(),a=new k(b),d.always(function(){a.destroy();a=null}),a.once("error",d.reject),a.once("load",
function(){c._info=c._info||a.info();c._meta=c._meta||a.meta();a.resize(b.width,b.height)}),a.once("complete",function(){var l,e;try{l=a.getAsBlob(b.type),e=c.size,l.size<e&&(c.source=l,c.size=l.size,c.trigger("resize",l.size,e)),c._compressed=!0,d.resolve()}catch(f){d.resolve()}}),c._info&&a.info(c._info),c._meta&&a.meta(c._meta),a.loadFromBlob(c.source),d.promise())}})}),m("file",["base","mediator"],function(f,h){function k(d){this.name=d.name||"Untitled";this.size=d.size||0;this.type=d.type||"application";
this.lastModifiedDate=d.lastModifiedDate||1*new Date;this.id=g+e++;this.ext=c.exec(this.name)?RegExp.$1:"";this.statusText="";a[this.id]=k.Status.INITED;this.source=d;this.loaded=0;this.on("error",function(b){this.setStatus(k.Status.ERROR,b)})}var g="WU_FILE_",e=0,c=/\.([^.]+)$/,a={};return f.$.extend(k.prototype,{setStatus:function(c,b){var l=a[this.id];"undefined"!=typeof b&&(this.statusText=b);c!==l&&(a[this.id]=c,this.trigger("statuschange",c,l))},getStatus:function(){return a[this.id]},getSource:function(){return this.source},
destory:function(){delete a[this.id]}}),h.installTo(k.prototype),k.Status={INITED:"inited",QUEUED:"queued",PROGRESS:"progress",ERROR:"error",COMPLETE:"complete",CANCELLED:"cancelled",INTERRUPT:"interrupt",INVALID:"invalid"},k}),m("queue",["base","mediator","file"],function(f,h,k){function g(){this.stats={numOfQueue:0,numOfSuccess:0,numOfCancel:0,numOfProgress:0,numOfUploadFailed:0,numOfInvalid:0};this._queue=[];this._map={}}var e=f.$,c=k.Status;return e.extend(g.prototype,{append:function(a){return this._queue.push(a),
this._fileAdded(a),this},prepend:function(a){return this._queue.unshift(a),this._fileAdded(a),this},getFile:function(a){return"string"!=typeof a?a:this._map[a]},fetch:function(a){var d,b,l=this._queue.length;a=a||c.QUEUED;for(d=0;l>d;d++)if(b=this._queue[d],a===b.getStatus())return b;return null},sort:function(a){"function"==typeof a&&this._queue.sort(a)},getFiles:function(){for(var a,c=[].slice.call(arguments,0),b=[],l=0,f=this._queue.length;f>l;l++)a=this._queue[l],c.length&&!~e.inArray(a.getStatus(),
c)||b.push(a);return b},_fileAdded:function(a){var d=this;this._map[a.id]||(this._map[a.id]=a,a.on("statuschange",function(b,a){d._onFileStatusChange(b,a)}));a.setStatus(c.QUEUED)},_onFileStatusChange:function(a,d){var b=this.stats;switch(d){case c.PROGRESS:b.numOfProgress--;break;case c.QUEUED:b.numOfQueue--;break;case c.ERROR:b.numOfUploadFailed--;break;case c.INVALID:b.numOfInvalid--}switch(a){case c.QUEUED:b.numOfQueue++;break;case c.PROGRESS:b.numOfProgress++;break;case c.ERROR:b.numOfUploadFailed++;
break;case c.COMPLETE:b.numOfSuccess++;break;case c.CANCELLED:b.numOfCancel++;break;case c.INVALID:b.numOfInvalid++}}}),h.installTo(g.prototype),g}),m("widgets/queue","base uploader queue file lib/file runtime/client widgets/widget".split(" "),function(f,h,k,g,e,c){var a=f.$,d=/\.\w+$/,b=g.Status;return h.register({"sort-files":"sortFiles","add-file":"addFiles","get-file":"getFile","fetch-file":"fetchFile","get-stats":"getStats","get-files":"getFiles","remove-file":"removeFile",retry:"retry",reset:"reset",
"accept-file":"acceptFile"},{init:function(b){var d,e,g,h,p,q,m,t=this;if(a.isPlainObject(b.accept)&&(b.accept=[b.accept]),b.accept){p=[];g=0;for(e=b.accept.length;e>g;g++)(h=b.accept[g].extensions)&&p.push(h);p.length&&(q="\\."+p.join(",").replace(/,/g,"$|\\.").replace(/\*/g,".*")+"$");t.accept=new RegExp(q,"i")}return t.queue=new k,t.stats=t.queue.stats,"html5"===this.request("predict-runtime-type")?(d=f.Deferred(),m=new c("Placeholder"),m.connectRuntime({runtimeOrder:"html5"},function(){t._ruid=
m.getRuid();d.resolve()}),d.promise()):void 0},_wrapFile:function(b){if(!(b instanceof g)){if(!(b instanceof e)){if(!this._ruid)throw Error("Can't add external files.");b=new e(this._ruid,b)}b=new g(b)}return b},acceptFile:function(b){return!(!b||6>b.size||this.accept&&d.exec(b.name)&&!this.accept.test(b.name))},_addFile:function(b){return b=this._wrapFile(b),this.owner.trigger("beforeFileQueued",b)?this.acceptFile(b)?(this.queue.append(b),this.owner.trigger("fileQueued",b),b):void this.owner.trigger("error",
"Q_TYPE_DENIED",b):void 0},getFile:function(b){return this.queue.getFile(b)},addFiles:function(b){var c=this;b.length||(b=[b]);b=a.map(b,function(b){return c._addFile(b)});c.owner.trigger("filesQueued",b);c.options.auto&&c.request("start-upload")},getStats:function(){return this.stats},removeFile:function(a){a=a.id?a:this.queue.getFile(a);a.setStatus(b.CANCELLED);this.owner.trigger("fileDequeued",a)},getFiles:function(){return this.queue.getFiles.apply(this.queue,arguments)},fetchFile:function(){return this.queue.fetch.apply(this.queue,
arguments)},retry:function(a,c){var d,e,f;if(a)return a=a.id?a:this.queue.getFile(a),a.setStatus(b.QUEUED),void(c||this.request("start-upload"));d=this.queue.getFiles(b.ERROR);e=0;for(f=d.length;f>e;e++)a=d[e],a.setStatus(b.QUEUED);this.request("start-upload")},sortFiles:function(){return this.queue.sort.apply(this.queue,arguments)},reset:function(){this.queue=new k;this.stats=this.queue.stats}})}),m("widgets/runtime",["uploader","runtime/runtime","widgets/widget"],function(f,h){return f.support=
function(){return h.hasRuntime.apply(h,arguments)},f.register({"predict-runtime-type":"predictRuntmeType"},{init:function(){if(!this.predictRuntmeType())throw Error("Runtime Error");},predictRuntmeType:function(){var f,g,e=this.options.runtimeOrder||h.orders,c=this.type;if(!c)for(e=e.split(/\s*,\s*/g),f=0,g=e.length;g>f;f++)if(h.hasRuntime(e[f])){this.type=c=e[f];break}return c}})}),m("lib/transport",["base","runtime/client","mediator"],function(f,h,k){function g(c){var a=this;c=a.options=e.extend(!0,
{},g.options,c||{});h.call(this,"Transport");this._blob=null;this._formData=c.formData||{};this._headers=c.headers||{};this.on("progress",this._timeout);this.on("load error",function(){a.trigger("progress",1);clearTimeout(a._timer)})}var e=f.$;return g.options={server:"",method:"POST",withCredentials:!1,fileVal:"file",timeout:12E4,formData:{},headers:{},sendAsBinary:!1},e.extend(g.prototype,{appendBlob:function(c,a,d){var b=this,e=b.options;b.getRuid()&&b.disconnectRuntime();b.connectRuntime(a.ruid,
function(){b.exec("init")});b._blob=a;e.fileVal=c||e.fileVal;e.filename=d||e.filename},append:function(c,a){"object"==typeof c?e.extend(this._formData,c):this._formData[c]=a},setRequestHeader:function(c,a){"object"==typeof c?e.extend(this._headers,c):this._headers[c]=a},send:function(c){this.exec("send",c);this._timeout()},abort:function(){return clearTimeout(this._timer),this.exec("abort")},destroy:function(){this.trigger("destroy");this.off();this.exec("destroy");this.disconnectRuntime()},getResponse:function(){return this.exec("getResponse")},
getResponseAsJson:function(){return this.exec("getResponseAsJson")},getStatus:function(){return this.exec("getStatus")},_timeout:function(){var c=this,a=c.options.timeout;a&&(clearTimeout(c._timer),c._timer=setTimeout(function(){c.abort();c.trigger("error","timeout")},a))}}),k.installTo(g.prototype),g}),m("widgets/upload",["base","uploader","file","lib/transport","widgets/widget"],function(f,h,k,g){function e(b,a){for(var c,d=[],e=b.source.size,f=a?Math.ceil(e/a):1,g=0,h=0;f>h;)c=Math.min(a,e-g),
d.push({file:b,start:g,end:a?g+c:e,total:e,chunks:f,chunk:h++}),g+=c;return b.blocks=d.concat(),b.remaning=d.length,{file:b,has:function(){return!!d.length},fetch:function(){return d.shift()}}}var c=f.$,a=f.isPromise,d=k.Status;c.extend(h.options,{prepareNextFile:!1,chunked:!1,chunkSize:5242880,chunkRetry:2,threads:3,formData:null});h.register({"start-upload":"start","stop-upload":"stop","skip-file":"skipFile","is-in-progress":"isInProgress"},{init:function(){var b=this.owner;this.runing=!1;this.pool=
[];this.pending=[];this.remaning=0;this.__tick=f.bindFn(this._tick,this);b.on("uploadComplete",function(b){b.blocks&&c.each(b.blocks,function(b,a){a.transport&&(a.transport.abort(),a.transport.destroy());delete a.transport});delete b.blocks;delete b.remaning})},start:function(){var b=this;c.each(b.request("get-files",d.INVALID),function(){b.request("remove-file",this)});b.runing||(b.runing=!0,c.each(b.pool,function(a,c){var e=c.file;e.getStatus()===d.INTERRUPT&&(e.setStatus(d.PROGRESS),b._trigged=
!1,c.transport&&c.transport.send())}),b._trigged=!1,b.owner.trigger("startUpload"),f.nextTick(b.__tick))},stop:function(b){!1!==this.runing&&(this.runing=!1,b&&c.each(this.pool,function(b,a){a.transport&&a.transport.abort();a.file.setStatus(d.INTERRUPT)}),this.owner.trigger("stopUpload"))},isInProgress:function(){return!!this.runing},getStats:function(){return this.request("get-stats")},skipFile:function(b,a){b=this.request("get-file",b);b.setStatus(a||d.COMPLETE);b.skipped=!0;b.blocks&&c.each(b.blocks,
function(b,a){var c=a.transport;c&&(c.abort(),c.destroy(),delete a.transport)});this.owner.trigger("uploadSkip",b)},_tick:function(){var b,c,d=this,e=d.options;return d._promise?d._promise.always(d.__tick):void(d.pool.length<e.threads&&(c=d._nextBlock())?(d._trigged=!1,b=function(b){d._promise=null;b&&b.file&&d._startSend(b);f.nextTick(d.__tick)},d._promise=a(c)?c.always(b):b(c)):d.remaning||d.getStats().numOfQueue||(d.runing=!1,d._trigged||f.nextTick(function(){d.owner.trigger("uploadFinished")}),
d._trigged=!0))},_nextBlock:function(){var b,c,f=this,g=f._act,h=f.options;return g&&g.has()&&g.file.getStatus()===d.PROGRESS?(h.prepareNextFile&&!f.pending.length&&f._prepareNextFile(),g.fetch()):f.runing?(!f.pending.length&&f.getStats().numOfQueue&&f._prepareNextFile(),b=f.pending.shift(),c=function(b){return b?(g=e(b,h.chunked?h.chunkSize:0),f._act=g,g.fetch()):null},a(b)?b[b.pipe?"pipe":"then"](c):c(b)):void 0},_prepareNextFile:function(){var b,a=this,e=a.request("fetch-file"),f=a.pending;e&&
(b=a.request("before-send-file",e,function(){return e.getStatus()===d.QUEUED?(a.owner.trigger("uploadStart",e),e.setStatus(d.PROGRESS),e):a._finishFile(e)}),b.done(function(){var a=c.inArray(b,f);~a&&f.splice(a,1,e)}),b.fail(function(b){e.setStatus(d.ERROR,b);a.owner.trigger("uploadError",e,b);a.owner.trigger("uploadComplete",e)}),f.push(b))},_popBlock:function(b){var a=c.inArray(b,this.pool);this.pool.splice(a,1);b.file.remaning--;this.remaning--},_startSend:function(b){var a=this,c=b.file;a.pool.push(b);
a.remaning++;b.blob=1===b.chunks?c.source:c.source.slice(b.start,b.end);a.request("before-send",b,function(){c.getStatus()===d.PROGRESS?a._doSend(b):(a._popBlock(b),f.nextTick(a.__tick))}).fail(function(){1===c.remaning?a._finishFile(c).always(function(){b.percentage=1;a._popBlock(b);a.owner.trigger("uploadComplete",c);f.nextTick(a.__tick)}):(b.percentage=1,a._popBlock(b),f.nextTick(a.__tick))})},_doSend:function(b){var a,e,h=this,k=h.owner,m=h.options,p=b.file,q=new g(m),u=c.extend({},m.formData),
t=c.extend({},m.headers);b.transport=q;q.on("destroy",function(){delete b.transport;h._popBlock(b);f.nextTick(h.__tick)});q.on("progress",function(a){var d=0,e=0,d=b.percentage=a;1<b.chunks&&(c.each(p.blocks,function(a,b){e+=(b.percentage||0)*(b.end-b.start)}),d=e/p.size);k.trigger("uploadProgress",p,d||0)});a=function(a){var c;return e=q.getResponseAsJson()||{},e._raw=q.getResponse(),c=function(b){a=b},k.trigger("uploadAccept",b,e,c)||(a=a||"server"),a};q.on("error",function(c,e){b.retried=b.retried||
0;1<b.chunks&&~"http,abort".indexOf(c)&&b.retried<m.chunkRetry?(b.retried++,q.send()):(e||"server"!==c||(c=a(c)),p.setStatus(d.ERROR,c),k.trigger("uploadError",p,c),k.trigger("uploadComplete",p))});q.on("load",function(){var b;return(b=a())?void q.trigger("error",b,!0):void(1===p.remaning?h._finishFile(p,e):q.destroy())});u=c.extend(u,{id:p.id,name:p.name,type:p.type,lastModifiedDate:p.lastModifiedDate,size:p.size});1<b.chunks&&c.extend(u,{chunks:b.chunks,chunk:b.chunk});k.trigger("uploadBeforeSend",
b,u,t);q.appendBlob(m.fileVal,b.blob,p.name);q.append(u);q.setRequestHeader(t);q.send()},_finishFile:function(b,a,c){var e=this.owner;return e.request("after-send-file",arguments,function(){b.setStatus(d.COMPLETE);e.trigger("uploadSuccess",b,a,c)}).fail(function(a){b.getStatus()===d.PROGRESS&&b.setStatus(d.ERROR,a);e.trigger("uploadError",b,a)}).always(function(){e.trigger("uploadComplete",b)})}})}),m("widgets/validator",["base","uploader","file","widgets/widget"],function(f,h,k){var g,e=f.$,c={};
return g={addValidator:function(a,d){c[a]=d},removeValidator:function(a){delete c[a]}},h.register({init:function(){var a=this;e.each(c,function(){this.call(a.owner)})}}),g.addValidator("fileNumLimit",function(){var a=0,c=this.options.fileNumLimit>>0,b=!0;c&&(this.on("beforeFileQueued",function(e){return a>=c&&b&&(b=!1,this.trigger("error","Q_EXCEED_NUM_LIMIT",c,e),setTimeout(function(){b=!0},1)),a>=c?!1:!0}),this.on("fileQueued",function(){a++}),this.on("fileDequeued",function(){a--}),this.on("uploadFinished",
function(){a=0}))}),g.addValidator("fileSizeLimit",function(){var a=0,c=this.options.fileSizeLimit>>0,b=!0;c&&(this.on("beforeFileQueued",function(e){var f=a+e.size>c;return f&&b&&(b=!1,this.trigger("error","Q_EXCEED_SIZE_LIMIT",c,e),setTimeout(function(){b=!0},1)),f?!1:!0}),this.on("fileQueued",function(b){a+=b.size}),this.on("fileDequeued",function(b){a-=b.size}),this.on("uploadFinished",function(){a=0}))}),g.addValidator("fileSingleSizeLimit",function(){var a=this.options.fileSingleSizeLimit;a&&
this.on("beforeFileQueued",function(c){return c.size>a?(c.setStatus(k.Status.INVALID,"exceed_size"),this.trigger("error","F_EXCEED_SIZE",c),!1):void 0})}),g.addValidator("duplicate",function(){var a={};this.options.duplicate||(this.on("beforeFileQueued",function(c){var b;if(!(b=c.__hash)){b=c.name+c.size+c.lastModifiedDate;for(var e,f=0,g=0,h=b.length;h>g;g++)e=b.charCodeAt(g),f=e+(f<<6)+(f<<16)-f;b=c.__hash=f}return a[b]?(this.trigger("error","F_DUPLICATE",c),!1):void 0}),this.on("fileQueued",function(c){(c=
c.__hash)&&(a[c]=!0)}),this.on("fileDequeued",function(c){(c=c.__hash)&&delete a[c]}))}),g}),m("runtime/compbase",[],function(){return function(f,h){this.owner=f;this.options=f.options;this.getRuntime=function(){return h};this.getRuid=function(){return h.uid};this.trigger=function(){return f.trigger.apply(f,arguments)}}}),m("runtime/flash/runtime",["base","runtime/runtime","runtime/compbase"],function(f,h,k){function g(){function d(a,b){var c,d;c=a.type||a;c=c.split("::");d=c[0];c=c[1];"Ready"===
c&&d===k.uid?k.trigger("ready"):e[d]&&e[d].trigger(c.toLowerCase(),a,b)}var b={},e={},g=this.destory,k=this,m=f.guid("webuploader_");h.apply(k,arguments);k.type=c;k.exec=function(c,d){var g,h=this.uid,m=f.slice(arguments,2);return e[h]=this,a[c]&&(b[h]||(b[h]=new a[c](this,k)),g=b[h],g[d])?g[d].apply(g,m):k.flashExec.apply(this,arguments)};r[m]=function(){var a=arguments;setTimeout(function(){d.apply(null,a)},1)};this.jsreciver=m;this.destory=function(){return g&&g.apply(this,arguments)};this.flashExec=
function(a,b){var c=k.getFlash(),d=f.slice(arguments,2);return c.exec(this.uid,a,b,d)}}var e=f.$,c="flash",a={};return f.inherits(h,{constructor:g,init:function(){var a,b=this.getContainer(),c=this.options;b.css({position:"absolute",top:"-8px",left:"-8px",width:"9px",height:"9px",overflow:"hidden"});a='<object id="'+this.uid+'" type="application/x-shockwave-flash" data="'+c.swf+'" ';f.browser.ie&&(a+='classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" ');a+='width="100%" height="100%" style="outline:0"><param name="movie" value="'+
c.swf+'" /><param name="flashvars" value="uid='+this.uid+"&jsreciver="+this.jsreciver+'" /><param name="wmode" value="transparent" /><param name="allowscriptaccess" value="always" /></object>';b.html(a)},getFlash:function(){return this._flash?this._flash:(this._flash=e("#"+this.uid).get(0),this._flash)}}),g.register=function(c,b){return b=a[c]=f.inherits(k,e.extend({flashExec:function(){var a=this.owner;return this.getRuntime().flashExec.apply(a,arguments)}},b))},11.4<=function(){var a;try{a=navigator.plugins["Shockwave Flash"],
a=a.description}catch(b){try{a=(new ActiveXObject("ShockwaveFlash.ShockwaveFlash")).GetVariable("$version")}catch(c){a="0.0"}}return a=a.match(/\d+/g),parseFloat(a[0]+"."+a[1],10)}()&&h.addRuntime(c,g),g}),m("runtime/flash/filepicker",["base","runtime/flash/runtime"],function(f,h){var k=f.$;return h.register("FilePicker",{init:function(f){var e,c=k.extend({},f);f=c.accept&&c.accept.length;for(e=0;f>e;e++)c.accept[e].title||(c.accept[e].title="Files");delete c.button;delete c.container;this.flashExec("FilePicker",
"init",c)},destroy:function(){}})}),m("runtime/flash/image",["runtime/flash/runtime"],function(f){return f.register("Image",{loadFromBlob:function(f){var k=this.owner;k.info()&&this.flashExec("Image","info",k.info());k.meta()&&this.flashExec("Image","meta",k.meta());this.flashExec("Image","loadFromBlob",f.uid)}})}),m("runtime/flash/transport",["base","runtime/flash/runtime","runtime/client"],function(f,h,k){var g=f.$;return h.register("Transport",{init:function(){this._status=0;this._responseJson=
this._response=null},send:function(){var e,c=this.owner,a=this.options,d=this._initAjax(),b=c._blob,f=a.server;d.connectRuntime(b.ruid);a.sendAsBinary?(f+=(/\?/.test(f)?"&":"?")+g.param(c._formData),e=b.uid):(g.each(c._formData,function(a,b){d.exec("append",a,b)}),d.exec("appendBlob",a.fileVal,b.uid,a.filename||c._formData.name||""));this._setRequestHeader(d,a.headers);d.exec("send",{method:a.method,url:f},e)},getStatus:function(){return this._status},getResponse:function(){return this._response},
getResponseAsJson:function(){return this._responseJson},abort:function(){var e=this._xhr;e&&(e.exec("abort"),e.destroy(),this._xhr=null)},destroy:function(){this.abort()},_initAjax:function(){var e=this,c=new k("XMLHttpRequest");return c.on("uploadprogress progress",function(a){return e.trigger("progress",a.loaded/a.total)}),c.on("load",function(){var a=c.exec("getStatus"),d="";return c.off(),e._xhr=null,200<=a&&300>a?(e._response=c.exec("getResponse"),e._responseJson=c.exec("getResponseAsJson")):
500<=a&&600>a?(e._response=c.exec("getResponse"),e._responseJson=c.exec("getResponseAsJson"),d="server"):d="http",c.destroy(),c=null,d?e.trigger("error",d):e.trigger("load")}),c.on("error",function(){c.off();e._xhr=null;e.trigger("error","http")}),e._xhr=c,c},_setRequestHeader:function(e,c){g.each(c,function(a,c){e.exec("setRequestHeader",a,c)})}})}),m("preset/flashonly","base widgets/filepicker widgets/image widgets/queue widgets/runtime widgets/upload widgets/validator runtime/flash/filepicker runtime/flash/image runtime/flash/transport".split(" "),
function(f){return f}),m("webuploader",["preset/flashonly"],function(f){return f}),v("webuploader")});