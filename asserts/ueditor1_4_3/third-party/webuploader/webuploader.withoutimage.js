(function(m,l){var r={},g=function(b,a){var d,f,c;if("string"===typeof b)return h(b);d=[];f=b.length;for(c=0;c<f;c++)d.push(h(b[c]));return a.apply(null,d)},h=function(b){var a=r[b]||m[b];if(!a)throw Error("`"+b+"` is undefined");return a},k=l(m,function(b,a,d){2===arguments.length&&(d=a,a=null);g(a||[],function(){var a=arguments,c={exports:d};"function"===typeof d&&(a.length||(a=[g,c.exports,c]),a=d.apply(null,a),void 0!==a&&(c.exports=a));r[b]=c.exports})},g),e;(function(b){var a,d,f,c,n,q;q=function(c){return c&&
c.charAt(0).toUpperCase()+c.substr(1)};for(a in r)if(d=b,r.hasOwnProperty(a)){f=a.split("/");for(n=q(f.pop());c=q(f.shift());)d[c]=d[c]||{},d=d[c];d[n]=r[a]}})(k);"object"===typeof module&&"object"===typeof module.exports?module.exports=k:"function"===typeof define&&define.amd?define([],k):(e=m.WebUploader,m.WebUploader=k,m.WebUploader.noConflict=function(){m.WebUploader=e})})(this,function(m,l,r){l("dollar-third",[],function(){return m.jQuery||m.Zepto});l("dollar",["dollar-third"],function(g){return g});
l("promise-third",["dollar"],function(g){return{Deferred:g.Deferred,when:g.when,isPromise:function(g){return g&&"function"===typeof g.then}}});l("promise",["promise-third"],function(g){return g});l("base",["dollar","promise"],function(g,h){function k(c,a){return function(){return c.apply(a,arguments)}}function e(c){var a;if(Object.create)return Object.create(c);a=function(){};a.prototype=c;return new a}var b=function(){},a=Function.call,d=h.Deferred,f=h.isPromise,c=h.when,n=function(c){var a={},d=
c.match(/WebKit\/([\d.]+)/),b=c.match(/Chrome\/([\d.]+)/)||c.match(/CriOS\/([\d.]+)/),n=c.match(/MSIE\s([\d\.]+)/)||c.match(/(?:trident)(?:.*rv:([\w.]+))?/i),f=c.match(/Firefox\/([\d.]+)/),q=c.match(/Safari\/([\d.]+)/);c=c.match(/OPR\/([\d.]+)/);d&&(a.webkit=parseFloat(d[1]));b&&(a.chrome=parseFloat(b[1]));n&&(a.ie=parseFloat(n[1]));f&&(a.firefox=parseFloat(f[1]));q&&(a.safari=parseFloat(q[1]));c&&(a.opera=parseFloat(c[1]));return a}(navigator.userAgent),q=function(c){var a={},d=c.match(/(?:Android);?[\s\/]+([\d.]+)?/);
c=c.match(/(?:iPad|iPod|iPhone).*OS\s([\d_]+)/);d&&(a.android=parseFloat(d[1]));c&&(a.ios=parseFloat(c[1].replace(/_/g,".")));return a}(navigator.userAgent),w;w=m.console?k(console.log,console):b;return{version:"0.1.2",$:g,Deferred:d,isPromise:f,when:c,browser:n,os:q,inherits:function(c,a,d){var b;"function"===typeof a?(b=a,a=null):b=a&&a.hasOwnProperty("constructor")?a.constructor:function(){return c.apply(this,arguments)};g.extend(!0,b,c,d||{});b.__super__=c.prototype;b.prototype=e(c.prototype);
a&&g.extend(!0,b.prototype,a);return b},noop:b,bindFn:k,log:w,nextTick:function(){return function(c){setTimeout(c,1)}}(),slice:function(c){return function(){return a.apply(c,arguments)}}([].slice),guid:function(){var c=0;return function(a){for(var d=(+new Date).toString(32),b=0;5>b;b++)d+=Math.floor(65535*Math.random()).toString(32);return(a||"wu_")+d+(c++).toString(32)}}(),formatSize:function(c,a,d){var b;for(d=d||["B","K","M","G","TB"];(b=d.shift())&&1024<c;)c/=1024;return("B"===b?c:c.toFixed(a||
2))+b}}});l("mediator",["base"],function(g){function h(c,a,d,f){return b.grep(c,function(c){return c&&(!a||c.e===a)&&(!d||c.cb===d||c.cb._cb===d)&&(!f||c.ctx===f)})}function k(c,a,f){b.each((c||"").split(d),function(c,d){f(d,a)})}function e(c,a){for(var d=!1,b=-1,f=c.length,g;++b<f;)if(g=c[b],!1===g.cb.apply(g.ctx2,a)){d=!0;break}return!d}var b=g.$,a=[].slice,d=/\s+/,f;f={on:function(c,a,d){var b=this,f;if(!a)return this;f=this._events||(this._events=[]);k(c,a,function(c,a){var n={e:c};n.cb=a;n.ctx=
d;n.ctx2=d||b;n.id=f.length;f.push(n)});return this},once:function(c,a,d){var b=this;if(!a)return b;k(c,a,function(c,a){var n=function(){b.off(c,n);return a.apply(d||b,arguments)};n._cb=a;b.on(c,n,d)});return b},off:function(c,a,d){var f=this._events;if(!f)return this;if(!c&&!a&&!d)return this._events=[],this;k(c,a,function(c,a){b.each(h(f,c,a,d),function(){delete f[this.id]})});return this},trigger:function(c){var d,b,f;if(!this._events||!c)return this;d=a.call(arguments,1);b=h(this._events,c);f=
h(this._events,"all");return e(b,d)&&e(f,arguments)}};return b.extend({installTo:function(c){return b.extend(c,f)}},f)});l("uploader",["base","mediator"],function(g,h){function k(b){this.options=e.extend(!0,{},k.options,b);this._init(this.options)}var e=g.$;k.options={};h.installTo(k.prototype);e.each({upload:"start-upload",stop:"stop-upload",getFile:"get-file",getFiles:"get-files",addFile:"add-file",addFiles:"add-file",sort:"sort-files",removeFile:"remove-file",skipFile:"skip-file",retry:"retry",
isInProgress:"is-in-progress",makeThumb:"make-thumb",getDimension:"get-dimension",addButton:"add-btn",getRuntimeType:"get-runtime-type",refresh:"refresh",disable:"disable",enable:"enable",reset:"reset"},function(b,a){k.prototype[b]=function(){return this.request(a,arguments)}});e.extend(k.prototype,{state:"pending",_init:function(b){var a=this;a.request("init",b,function(){a.state="ready";a.trigger("ready")})},option:function(b,a){var d=this.options;if(1<arguments.length)e.isPlainObject(a)&&e.isPlainObject(d[b])?
e.extend(d[b],a):d[b]=a;else return b?d[b]:d},getStats:function(){var b=this.request("get-stats");return{successNum:b.numOfSuccess,cancelNum:b.numOfCancel,invalidNum:b.numOfInvalid,uploadFailNum:b.numOfUploadFailed,queueNum:b.numOfQueue}},trigger:function(b){var a=[].slice.call(arguments,1),d=this.options,f="on"+b.substring(0,1).toUpperCase()+b.substring(1);return!1===h.trigger.apply(this,arguments)||e.isFunction(d[f])&&!1===d[f].apply(this,a)||e.isFunction(this[f])&&!1===this[f].apply(this,a)||!1===
h.trigger.apply(h,[this,b].concat(a))?!1:!0},request:g.noop});g.create=k.create=function(b){return new k(b)};return g.Uploader=k});l("runtime/runtime",["base","mediator"],function(g,h){function k(a){this.options=e.extend({container:document.body},a);this.uid=g.guid("rt_")}var e=g.$,b={},a=function(a){for(var b in a)if(a.hasOwnProperty(b))return b;return null};e.extend(k.prototype,{getContainer:function(){var a,b;if(this._container)return this._container;a=e(this.options.container||document.body);
b=e(document.createElement("div"));b.attr("id","rt_"+this.uid);b.css({position:"absolute",top:"0px",left:"0px",width:"1px",height:"1px",overflow:"hidden"});a.append(b);a.addClass("webuploader-container");return this._container=b},init:g.noop,exec:g.noop,destroy:function(){this._container&&this._container.parentNode.removeChild(this.__container);this.off()}});k.orders="html5,flash";k.addRuntime=function(a,f){b[a]=f};k.hasRuntime=function(d){return!(d?!b[d]:!a(b))};k.create=function(d,f){var c;f=f||
k.orders;e.each(f.split(/\s*,\s*/g),function(){if(b[this])return c=this,!1});c=c||a(b);if(!c)throw Error("Runtime Error");return new b[c](d)};h.installTo(k.prototype);return k});l("runtime/client",["base","mediator","runtime/runtime"],function(g,h,k){function e(a,d){var f=g.Deferred(),c;this.uid=g.guid("client_");this.runtimeReady=function(c){return f.done(c)};this.connectRuntime=function(a,e){if(c)throw Error("already connected!");f.done(e);"string"===typeof a&&b.get(a)&&(c=b.get(a));(c=c||b.get(null,
d))?(g.$.extend(c.options,a),c.__promise.then(f.resolve),c.__client++):(c=k.create(a,a.runtimeOrder),c.__promise=f.promise(),c.once("ready",f.resolve),c.init(),b.add(c),c.__client=1);d&&(c.__standalone=d);return c};this.getRuntime=function(){return c};this.disconnectRuntime=function(){c&&(c.__client--,0>=c.__client&&(b.remove(c),delete c.__promise,c.destroy()),c=null)};this.exec=function(){if(c){var b=g.slice(arguments);a&&b.unshift(a);return c.exec.apply(this,b)}};this.getRuid=function(){return c&&
c.uid};this.destroy=function(c){return function(){c&&c.apply(this,arguments);this.trigger("destroy");this.off();this.exec("destroy");this.disconnectRuntime()}}(this.destroy)}var b;b=function(){var a={};return{add:function(b){a[b.uid]=b},get:function(b,f){var c;if(b)return a[b];for(c in a)if(!f||!a[c].__standalone)return a[c];return null},remove:function(b){delete a[b.uid]}}}();h.installTo(e.prototype);return e});l("lib/dnd",["base","mediator","runtime/client"],function(g,h,k){function e(a){a=this.options=
b.extend({},e.options,a);a.container=b(a.container);a.container.length&&k.call(this,"DragAndDrop")}var b=g.$;e.options={accept:null,disableGlobalDnd:!1};g.inherits(k,{constructor:e,init:function(){var a=this;a.connectRuntime(a.options,function(){a.exec("init");a.trigger("ready")})},destroy:function(){this.disconnectRuntime()}});h.installTo(e.prototype);return e});l("widgets/widget",["base","uploader"],function(g,h){function k(c){if(!c)return!1;var a=c.length,d=b.type(c);return 1===c.nodeType&&a?!0:
"array"===d||"function"!==d&&"string"!==d&&(0===a||"number"===typeof a&&0<a&&a-1 in c)}function e(c){this.owner=c;this.options=c.options}var b=g.$,a=h.prototype._init,d={},f=[];b.extend(e.prototype,{init:g.noop,invoke:function(c,a){var f=this.responseMap;return f&&c in f&&f[c]in this&&b.isFunction(this[f[c]])?this[f[c]].apply(this,a):d},request:function(){return this.owner.request.apply(this.owner,arguments)}});b.extend(h.prototype,{_init:function(){var c=this,d=c._widgets=[];b.each(f,function(a,
b){d.push(new b(c))});return a.apply(c,arguments)},request:function(c,a,b){var f=0,e=this._widgets,h=e.length,l=[],t=[],m;for(a=k(a)?a:[a];f<h;f++)m=e[f],m=m.invoke(c,a),m!==d&&(g.isPromise(m)?t.push(m):l.push(m));return b||t.length?(c=g.when.apply(g,t),a=c.pipe?"pipe":"then",c[a](function(){var a=g.Deferred(),c=arguments;setTimeout(function(){a.resolve.apply(a,c)},1);return a.promise()})[a](b||g.noop)):l[0]}});h.register=e.register=function(a,d){var q={init:"init"};1===arguments.length?(d=a,d.responseMap=
q):d.responseMap=b.extend(q,a);q=g.inherits(e,d);f.push(q);return q};return e});l("widgets/filednd",["base","uploader","lib/dnd","widgets/widget"],function(g,h,k){var e=g.$;h.options.dnd="";return h.register({init:function(b){if(b.dnd&&"html5"===this.request("predict-runtime-type")){var a=this,d=g.Deferred();b=e.extend({},{disableGlobalDnd:b.disableGlobalDnd,container:b.dnd,accept:b.accept});b=new k(b);b.once("ready",d.resolve);b.on("drop",function(b){a.request("add-file",[b])});b.on("accept",function(b){return a.owner.trigger("dndAccept",
b)});b.init();return d.promise()}}})});l("lib/filepaste",["base","mediator","runtime/client"],function(g,h,k){function e(a){a=this.options=b.extend({},a);a.container=b(a.container||document.body);k.call(this,"FilePaste")}var b=g.$;g.inherits(k,{constructor:e,init:function(){var a=this;a.connectRuntime(a.options,function(){a.exec("init");a.trigger("ready")})},destroy:function(){this.exec("destroy");this.disconnectRuntime();this.off()}});h.installTo(e.prototype);return e});l("widgets/filepaste",["base",
"uploader","lib/filepaste","widgets/widget"],function(g,h,k){var e=g.$;return h.register({init:function(b){if(b.paste&&"html5"===this.request("predict-runtime-type")){var a=this,d=g.Deferred();b=e.extend({},{container:b.paste,accept:b.accept});b=new k(b);b.once("ready",d.resolve);b.on("paste",function(b){a.owner.request("add-file",[b])});b.init();return d.promise()}}})});l("lib/blob",["base","runtime/client"],function(g,h){function k(e,b){this.source=b;this.ruid=e;h.call(this,"Blob");this.uid=b.uid||
this.uid;this.type=b.type||"";this.size=b.size||0;e&&this.connectRuntime(e)}g.inherits(h,{constructor:k,slice:function(e,b){return this.exec("slice",e,b)},getSource:function(){return this.source}});return k});l("lib/file",["base","lib/blob"],function(g,h){function k(a,d){var f;h.apply(this,arguments);this.name=d.name||"untitled"+e++;f=b.exec(d.name)?RegExp.$1.toLowerCase():"";!f&&this.type&&(f=/\/(jpg|jpeg|png|gif|bmp)$/i.exec(this.type)?RegExp.$1.toLowerCase():"",this.name+="."+f);!this.type&&~"jpg,jpeg,png,gif,bmp".indexOf(f)&&
(this.type="image/"+("jpg"===f?"jpeg":f));this.ext=f;this.lastModifiedDate=d.lastModifiedDate||(new Date).toLocaleString()}var e=1,b=/\.([^.]+)$/;return g.inherits(h,k)});l("lib/filepicker",["base","runtime/client","lib/file"],function(g,h,k){function e(a){a=this.options=b.extend({},e.options,a);a.container=b(a.id);if(!a.container.length)throw Error("\u6309\u94ae\u6307\u5b9a\u9519\u8bef");a.innerHTML=a.innerHTML||a.label||a.container.html()||"";a.button=b(a.button||document.createElement("div"));
a.button.html(a.innerHTML);a.container.html(a.button);h.call(this,"FilePicker",!0)}var b=g.$;e.options={button:null,container:null,label:null,innerHTML:null,multiple:!0,accept:null,name:"file"};g.inherits(h,{constructor:e,init:function(){var a=this,d=a.options,f=d.button;f.addClass("webuploader-pick");a.on("all",function(c){switch(c){case "mouseenter":f.addClass("webuploader-pick-hover");break;case "mouseleave":f.removeClass("webuploader-pick-hover");break;case "change":c=a.exec("getFiles"),a.trigger("select",
b.map(c,function(c){c=new k(a.getRuid(),c);c._refer=d.container;return c}),d.container)}});a.connectRuntime(d,function(){a.refresh();a.exec("init",d);a.trigger("ready")});b(m).on("resize",function(){a.refresh()})},refresh:function(){var a=this.getRuntime().getContainer(),b=this.options.button,f=b.outerWidth?b.outerWidth():b.width(),c=b.outerHeight?b.outerHeight():b.height(),b=b.offset();f&&c&&a.css({bottom:"auto",right:"auto",width:f+"px",height:c+"px"}).offset(b)},enable:function(){this.options.button.removeClass("webuploader-pick-disable");
this.refresh()},disable:function(){var a=this.options.button;this.getRuntime().getContainer().css({top:"-99999px"});a.addClass("webuploader-pick-disable")},destroy:function(){this.runtime&&(this.exec("destroy"),this.disconnectRuntime())}});return e});l("widgets/filepicker",["base","uploader","lib/filepicker","widgets/widget"],function(g,h,k){var e=g.$;e.extend(h.options,{pick:null,accept:null});return h.register({"add-btn":"addButton",refresh:"refresh",disable:"disable",enable:"enable"},{init:function(b){this.pickers=
[];return b.pick&&this.addButton(b.pick)},refresh:function(){e.each(this.pickers,function(){this.refresh()})},addButton:function(b){var a=this,d=a.options,f=d.accept,c;if(b)return c=g.Deferred(),e.isPlainObject(b)||(b={id:b}),b=e.extend({},b,{accept:e.isPlainObject(f)?[f]:f,swf:d.swf,runtimeOrder:d.runtimeOrder}),b=new k(b),b.once("ready",c.resolve),b.on("select",function(c){a.owner.request("add-file",[c])}),b.init(),this.pickers.push(b),c.promise()},disable:function(){e.each(this.pickers,function(){this.disable()})},
enable:function(){e.each(this.pickers,function(){this.enable()})}})});l("file",["base","mediator"],function(g,h){function k(d){this.name=d.name||"Untitled";this.size=d.size||0;this.type=d.type||"application";this.lastModifiedDate=d.lastModifiedDate||1*new Date;this.id="WU_FILE_"+e++;this.ext=b.exec(this.name)?RegExp.$1:"";this.statusText="";a[this.id]=k.Status.INITED;this.source=d;this.loaded=0;this.on("error",function(a){this.setStatus(k.Status.ERROR,a)})}var e=0,b=/\.([^.]+)$/,a={};g.$.extend(k.prototype,
{setStatus:function(b,f){var c=a[this.id];"undefined"!==typeof f&&(this.statusText=f);b!==c&&(a[this.id]=b,this.trigger("statuschange",b,c))},getStatus:function(){return a[this.id]},getSource:function(){return this.source},destory:function(){delete a[this.id]}});h.installTo(k.prototype);k.Status={INITED:"inited",QUEUED:"queued",PROGRESS:"progress",ERROR:"error",COMPLETE:"complete",CANCELLED:"cancelled",INTERRUPT:"interrupt",INVALID:"invalid"};return k});l("queue",["base","mediator","file"],function(g,
h,k){function e(){this.stats={numOfQueue:0,numOfSuccess:0,numOfCancel:0,numOfProgress:0,numOfUploadFailed:0,numOfInvalid:0};this._queue=[];this._map={}}var b=g.$,a=k.Status;b.extend(e.prototype,{append:function(a){this._queue.push(a);this._fileAdded(a);return this},prepend:function(a){this._queue.unshift(a);this._fileAdded(a);return this},getFile:function(a){return"string"!==typeof a?a:this._map[a]},fetch:function(b){var f=this._queue.length,c,n;b=b||a.QUEUED;for(c=0;c<f;c++)if(n=this._queue[c],b===
n.getStatus())return n;return null},sort:function(a){"function"===typeof a&&this._queue.sort(a)},getFiles:function(){for(var a=[].slice.call(arguments,0),f=[],c=0,n=this._queue.length,e;c<n;c++)e=this._queue[c],a.length&&!~b.inArray(e.getStatus(),a)||f.push(e);return f},_fileAdded:function(b){var f=this;this._map[b.id]||(this._map[b.id]=b,b.on("statuschange",function(a,b){f._onFileStatusChange(a,b)}));b.setStatus(a.QUEUED)},_onFileStatusChange:function(b,f){var c=this.stats;switch(f){case a.PROGRESS:c.numOfProgress--;
break;case a.QUEUED:c.numOfQueue--;break;case a.ERROR:c.numOfUploadFailed--;break;case a.INVALID:c.numOfInvalid--}switch(b){case a.QUEUED:c.numOfQueue++;break;case a.PROGRESS:c.numOfProgress++;break;case a.ERROR:c.numOfUploadFailed++;break;case a.COMPLETE:c.numOfSuccess++;break;case a.CANCELLED:c.numOfCancel++;break;case a.INVALID:c.numOfInvalid++}}});h.installTo(e.prototype);return e});l("widgets/queue","base uploader queue file lib/file runtime/client widgets/widget".split(" "),function(g,h,k,e,
b,a){var d=g.$,f=/\.\w+$/,c=e.Status;return h.register({"sort-files":"sortFiles","add-file":"addFiles","get-file":"getFile","fetch-file":"fetchFile","get-stats":"getStats","get-files":"getFiles","remove-file":"removeFile",retry:"retry",reset:"reset","accept-file":"acceptFile"},{init:function(c){var b=this,f,e,h,l,t,m,u;d.isPlainObject(c.accept)&&(c.accept=[c.accept]);if(c.accept){t=[];h=0;for(e=c.accept.length;h<e;h++)(l=c.accept[h].extensions)&&t.push(l);t.length&&(m="\\."+t.join(",").replace(/,/g,
"$|\\.").replace(/\*/g,".*")+"$");b.accept=new RegExp(m,"i")}b.queue=new k;b.stats=b.queue.stats;if("html5"===this.request("predict-runtime-type"))return f=g.Deferred(),u=new a("Placeholder"),u.connectRuntime({runtimeOrder:"html5"},function(){b._ruid=u.getRuid();f.resolve()}),f.promise()},_wrapFile:function(a){if(!(a instanceof e)){if(!(a instanceof b)){if(!this._ruid)throw Error("Can't add external files.");a=new b(this._ruid,a)}a=new e(a)}return a},acceptFile:function(a){return!(!a||6>a.size||this.accept&&
f.exec(a.name)&&!this.accept.test(a.name))},_addFile:function(a){a=this._wrapFile(a);if(this.owner.trigger("beforeFileQueued",a)){if(this.acceptFile(a))return this.queue.append(a),this.owner.trigger("fileQueued",a),a;this.owner.trigger("error","Q_TYPE_DENIED",a)}},getFile:function(a){return this.queue.getFile(a)},addFiles:function(a){var c=this;a.length||(a=[a]);a=d.map(a,function(a){return c._addFile(a)});c.owner.trigger("filesQueued",a);c.options.auto&&c.request("start-upload")},getStats:function(){return this.stats},
removeFile:function(a){a=a.id?a:this.queue.getFile(a);a.setStatus(c.CANCELLED);this.owner.trigger("fileDequeued",a)},getFiles:function(){return this.queue.getFiles.apply(this.queue,arguments)},fetchFile:function(){return this.queue.fetch.apply(this.queue,arguments)},retry:function(a,b){var d,f,e;if(a)a=a.id?a:this.queue.getFile(a),a.setStatus(c.QUEUED),b||this.request("start-upload");else{d=this.queue.getFiles(c.ERROR);f=0;for(e=d.length;f<e;f++)a=d[f],a.setStatus(c.QUEUED);this.request("start-upload")}},
sortFiles:function(){return this.queue.sort.apply(this.queue,arguments)},reset:function(){this.queue=new k;this.stats=this.queue.stats}})});l("widgets/runtime",["uploader","runtime/runtime","widgets/widget"],function(g,h){g.support=function(){return h.hasRuntime.apply(h,arguments)};return g.register({"predict-runtime-type":"predictRuntmeType"},{init:function(){if(!this.predictRuntmeType())throw Error("Runtime Error");},predictRuntmeType:function(){var g=this.options.runtimeOrder||h.orders,e=this.type,
b,a;if(!e)for(g=g.split(/\s*,\s*/g),b=0,a=g.length;b<a;b++)if(h.hasRuntime(g[b])){this.type=e=g[b];break}return e}})});l("lib/transport",["base","runtime/client","mediator"],function(g,h,k){function e(a){var d=this;a=d.options=b.extend(!0,{},e.options,a||{});h.call(this,"Transport");this._blob=null;this._formData=a.formData||{};this._headers=a.headers||{};this.on("progress",this._timeout);this.on("load error",function(){d.trigger("progress",1);clearTimeout(d._timer)})}var b=g.$;e.options={server:"",
method:"POST",withCredentials:!1,fileVal:"file",timeout:12E4,formData:{},headers:{},sendAsBinary:!1};b.extend(e.prototype,{appendBlob:function(a,b,f){var c=this,e=c.options;c.getRuid()&&c.disconnectRuntime();c.connectRuntime(b.ruid,function(){c.exec("init")});c._blob=b;e.fileVal=a||e.fileVal;e.filename=f||e.filename},append:function(a,d){"object"===typeof a?b.extend(this._formData,a):this._formData[a]=d},setRequestHeader:function(a,d){"object"===typeof a?b.extend(this._headers,a):this._headers[a]=
d},send:function(a){this.exec("send",a);this._timeout()},abort:function(){clearTimeout(this._timer);return this.exec("abort")},destroy:function(){this.trigger("destroy");this.off();this.exec("destroy");this.disconnectRuntime()},getResponse:function(){return this.exec("getResponse")},getResponseAsJson:function(){return this.exec("getResponseAsJson")},getStatus:function(){return this.exec("getStatus")},_timeout:function(){var a=this,b=a.options.timeout;b&&(clearTimeout(a._timer),a._timer=setTimeout(function(){a.abort();
a.trigger("error","timeout")},b))}});k.installTo(e.prototype);return e});l("widgets/upload",["base","uploader","file","lib/transport","widgets/widget"],function(g,h,k,e){function b(a,b){for(var d=[],f=a.source.size,e=b?Math.ceil(f/b):1,g=0,h=0,k;h<e;)k=Math.min(b,f-g),d.push({file:a,start:g,end:b?g+k:f,total:f,chunks:e,chunk:h++}),g+=k;a.blocks=d.concat();a.remaning=d.length;return{file:a,has:function(){return!!d.length},fetch:function(){return d.shift()}}}var a=g.$,d=g.isPromise,f=k.Status;a.extend(h.options,
{prepareNextFile:!1,chunked:!1,chunkSize:5242880,chunkRetry:2,threads:3,formData:null});h.register({"start-upload":"start","stop-upload":"stop","skip-file":"skipFile","is-in-progress":"isInProgress"},{init:function(){var c=this.owner;this.runing=!1;this.pool=[];this.pending=[];this.remaning=0;this.__tick=g.bindFn(this._tick,this);c.on("uploadComplete",function(c){c.blocks&&a.each(c.blocks,function(a,c){c.transport&&(c.transport.abort(),c.transport.destroy());delete c.transport});delete c.blocks;delete c.remaning})},
start:function(){var c=this;a.each(c.request("get-files",f.INVALID),function(){c.request("remove-file",this)});c.runing||(c.runing=!0,a.each(c.pool,function(a,b){var d=b.file;d.getStatus()===f.INTERRUPT&&(d.setStatus(f.PROGRESS),c._trigged=!1,b.transport&&b.transport.send())}),c._trigged=!1,c.owner.trigger("startUpload"),g.nextTick(c.__tick))},stop:function(c){!1!==this.runing&&(this.runing=!1,c&&a.each(this.pool,function(a,c){c.transport&&c.transport.abort();c.file.setStatus(f.INTERRUPT)}),this.owner.trigger("stopUpload"))},
isInProgress:function(){return!!this.runing},getStats:function(){return this.request("get-stats")},skipFile:function(c,b){c=this.request("get-file",c);c.setStatus(b||f.COMPLETE);c.skipped=!0;c.blocks&&a.each(c.blocks,function(a,c){var b=c.transport;b&&(b.abort(),b.destroy(),delete c.transport)});this.owner.trigger("uploadSkip",c)},_tick:function(){var a=this,b=a.options,f;if(a._promise)return a._promise.always(a.__tick);a.pool.length<b.threads&&(f=a._nextBlock())?(a._trigged=!1,b=function(b){a._promise=
null;b&&b.file&&a._startSend(b);g.nextTick(a.__tick)},a._promise=d(f)?f.always(b):b(f)):a.remaning||a.getStats().numOfQueue||(a.runing=!1,a._trigged||g.nextTick(function(){a.owner.trigger("uploadFinished")}),a._trigged=!0)},_nextBlock:function(){var a=this,e=a._act,g=a.options,h,k;if(e&&e.has()&&e.file.getStatus()===f.PROGRESS)return g.prepareNextFile&&!a.pending.length&&a._prepareNextFile(),e.fetch();if(a.runing)return!a.pending.length&&a.getStats().numOfQueue&&a._prepareNextFile(),h=a.pending.shift(),
k=function(d){if(!d)return null;e=b(d,g.chunked?g.chunkSize:0);a._act=e;return e.fetch()},d(h)?h[h.pipe?"pipe":"then"](k):k(h)},_prepareNextFile:function(){var b=this,d=b.request("fetch-file"),e=b.pending,g;d&&(g=b.request("before-send-file",d,function(){return d.getStatus()===f.QUEUED?(b.owner.trigger("uploadStart",d),d.setStatus(f.PROGRESS),d):b._finishFile(d)}),g.done(function(){var b=a.inArray(g,e);~b&&e.splice(b,1,d)}),g.fail(function(a){d.setStatus(f.ERROR,a);b.owner.trigger("uploadError",d,
a);b.owner.trigger("uploadComplete",d)}),e.push(g))},_popBlock:function(b){var d=a.inArray(b,this.pool);this.pool.splice(d,1);b.file.remaning--;this.remaning--},_startSend:function(a){var b=this,d=a.file;b.pool.push(a);b.remaning++;a.blob=1===a.chunks?d.source:d.source.slice(a.start,a.end);b.request("before-send",a,function(){d.getStatus()===f.PROGRESS?b._doSend(a):(b._popBlock(a),g.nextTick(b.__tick))}).fail(function(){1===d.remaning?b._finishFile(d).always(function(){a.percentage=1;b._popBlock(a);
b.owner.trigger("uploadComplete",d);g.nextTick(b.__tick)}):(a.percentage=1,b._popBlock(a),g.nextTick(b.__tick))})},_doSend:function(b){var d=this,h=d.owner,k=d.options,l=b.file,p=new e(k),v=a.extend({},k.formData),m=a.extend({},k.headers),r,u;b.transport=p;p.on("destroy",function(){delete b.transport;d._popBlock(b);g.nextTick(d.__tick)});p.on("progress",function(d){var f=0,e=0,f=b.percentage=d;1<b.chunks&&(a.each(l.blocks,function(a,b){e+=(b.percentage||0)*(b.end-b.start)}),f=e/l.size);h.trigger("uploadProgress",
l,f||0)});r=function(a){u=p.getResponseAsJson()||{};u._raw=p.getResponse();h.trigger("uploadAccept",b,u,function(b){a=b})||(a=a||"server");return a};p.on("error",function(a,d){b.retried=b.retried||0;1<b.chunks&&~"http,abort".indexOf(a)&&b.retried<k.chunkRetry?(b.retried++,p.send()):(d||"server"!==a||(a=r(a)),l.setStatus(f.ERROR,a),h.trigger("uploadError",l,a),h.trigger("uploadComplete",l))});p.on("load",function(){var a;(a=r())?p.trigger("error",a,!0):1===l.remaning?d._finishFile(l,u):p.destroy()});
v=a.extend(v,{id:l.id,name:l.name,type:l.type,lastModifiedDate:l.lastModifiedDate,size:l.size});1<b.chunks&&a.extend(v,{chunks:b.chunks,chunk:b.chunk});h.trigger("uploadBeforeSend",b,v,m);p.appendBlob(k.fileVal,b.blob,l.name);p.append(v);p.setRequestHeader(m);p.send()},_finishFile:function(a,b,d){var e=this.owner;return e.request("after-send-file",arguments,function(){a.setStatus(f.COMPLETE);e.trigger("uploadSuccess",a,b,d)}).fail(function(b){a.getStatus()===f.PROGRESS&&a.setStatus(f.ERROR,b);e.trigger("uploadError",
a,b)}).always(function(){e.trigger("uploadComplete",a)})}})});l("widgets/validator",["base","uploader","file","widgets/widget"],function(g,h,k){var e=g.$,b={};g={addValidator:function(a,d){b[a]=d},removeValidator:function(a){delete b[a]}};h.register({init:function(){var a=this;e.each(b,function(){this.call(a.owner)})}});g.addValidator("fileNumLimit",function(){var a=0,b=this.options.fileNumLimit>>0,f=!0;b&&(this.on("beforeFileQueued",function(c){a>=b&&f&&(f=!1,this.trigger("error","Q_EXCEED_NUM_LIMIT",
b,c),setTimeout(function(){f=!0},1));return a>=b?!1:!0}),this.on("fileQueued",function(){a++}),this.on("fileDequeued",function(){a--}),this.on("uploadFinished",function(){a=0}))});g.addValidator("fileSizeLimit",function(){var a=0,b=this.options.fileSizeLimit>>0,f=!0;b&&(this.on("beforeFileQueued",function(c){var e=a+c.size>b;e&&f&&(f=!1,this.trigger("error","Q_EXCEED_SIZE_LIMIT",b,c),setTimeout(function(){f=!0},1));return e?!1:!0}),this.on("fileQueued",function(b){a+=b.size}),this.on("fileDequeued",
function(b){a-=b.size}),this.on("uploadFinished",function(){a=0}))});g.addValidator("fileSingleSizeLimit",function(){var a=this.options.fileSingleSizeLimit;if(a)this.on("beforeFileQueued",function(b){if(b.size>a)return b.setStatus(k.Status.INVALID,"exceed_size"),this.trigger("error","F_EXCEED_SIZE",b),!1})});g.addValidator("duplicate",function(){var a={};this.options.duplicate||(this.on("beforeFileQueued",function(b){var f;if(!(f=b.__hash)){f=b.name+b.size+b.lastModifiedDate;for(var c=0,e=0,g=f.length,
h;e<g;e++)h=f.charCodeAt(e),c=h+(c<<6)+(c<<16)-c;f=b.__hash=c}if(a[f])return this.trigger("error","F_DUPLICATE",b),!1}),this.on("fileQueued",function(b){(b=b.__hash)&&(a[b]=!0)}),this.on("fileDequeued",function(b){(b=b.__hash)&&delete a[b]}))});return g});l("runtime/compbase",[],function(){return function(g,h){this.owner=g;this.options=g.options;this.getRuntime=function(){return h};this.getRuid=function(){return h.uid};this.trigger=function(){return g.trigger.apply(g,arguments)}}});l("runtime/html5/runtime",
["base","runtime/runtime","runtime/compbase"],function(g,h,k){function e(){var a={},d=this,f=this.destory;h.apply(d,arguments);d.type="html5";d.exec=function(c,f){var e=this.uid,h=g.slice(arguments,2);if(b[c]&&(e=a[e]=a[e]||new b[c](this,d),e[f]))return e[f].apply(e,h)};d.destory=function(){return f&&f.apply(this,arguments)}}var b={};g.inherits(h,{constructor:e,init:function(){var a=this;setTimeout(function(){a.trigger("ready")},1)}});e.register=function(a,d){return b[a]=g.inherits(k,d)};m.Blob&&
m.FileReader&&m.DataView&&h.addRuntime("html5",e);return e});l("runtime/html5/blob",["runtime/html5/runtime","lib/blob"],function(g,h){return g.register("Blob",{slice:function(g,e){var b=this.owner.source,b=(b.slice||b.webkitSlice||b.mozSlice).call(b,g,e);return new h(this.getRuid(),b)}})});l("runtime/html5/dnd",["base","runtime/html5/runtime","lib/file"],function(g,h,k){var e=g.$;return h.register("DragAndDrop",{init:function(){var b=this.elem=this.options.container;this.dragEnterHandler=g.bindFn(this._dragEnterHandler,
this);this.dragOverHandler=g.bindFn(this._dragOverHandler,this);this.dragLeaveHandler=g.bindFn(this._dragLeaveHandler,this);this.dropHandler=g.bindFn(this._dropHandler,this);this.dndOver=!1;b.on("dragenter",this.dragEnterHandler);b.on("dragover",this.dragOverHandler);b.on("dragleave",this.dragLeaveHandler);b.on("drop",this.dropHandler);this.options.disableGlobalDnd&&(e(document).on("dragover",this.dragOverHandler),e(document).on("drop",this.dropHandler))},_dragEnterHandler:function(b){var a=this._denied||
!1,d;b=b.originalEvent||b;this.dndOver||(this.dndOver=!0,(d=b.dataTransfer.items)&&d.length&&(this._denied=a=!this.trigger("accept",d)),this.elem.addClass("webuploader-dnd-over"),this.elem[a?"addClass":"removeClass"]("webuploader-dnd-denied"));b.dataTransfer.dropEffect=a?"none":"copy";return!1},_dragOverHandler:function(b){var a=this.elem.parent().get(0);if(a&&!e.contains(a,b.currentTarget))return!1;clearTimeout(this._leaveTimer);this._dragEnterHandler.call(this,b);return!1},_dragLeaveHandler:function(){var b=
this;clearTimeout(b._leaveTimer);b._leaveTimer=setTimeout(function(){b.dndOver=!1;b.elem.removeClass("webuploader-dnd-over webuploader-dnd-denied")},100);return!1},_dropHandler:function(b){var a=this,d=a.getRuid(),f=a.elem.parent().get(0);if(f&&!e.contains(f,b.currentTarget))return!1;a._getTansferFiles(b,function(b){a.trigger("drop",e.map(b,function(a){return new k(d,a)}))});a.dndOver=!1;a.elem.removeClass("webuploader-dnd-over");return!1},_getTansferFiles:function(b,a){var d=[],f=[],c,e,h,k,l,p,
m;b=b.originalEvent||b;e=b.dataTransfer;c=e.items;e=e.files;m=!(!c||!c[0].webkitGetAsEntry);l=0;for(p=e.length;l<p;l++)h=e[l],k=c&&c[l],m&&k.webkitGetAsEntry().isDirectory?f.push(this._traverseDirectoryTree(k.webkitGetAsEntry(),d)):d.push(h);g.when.apply(g,f).done(function(){d.length&&a(d)})},_traverseDirectoryTree:function(b,a){var d=g.Deferred(),f=this;b.isFile?b.file(function(b){a.push(b);d.resolve()}):b.isDirectory&&b.createReader().readEntries(function(b){var e=b.length,h=[],k=[],l;for(l=0;l<
e;l++)h.push(f._traverseDirectoryTree(b[l],k));g.when.apply(g,h).then(function(){a.push.apply(a,k);d.resolve()},d.reject)});return d.promise()},destroy:function(){var b=this.elem;b.off("dragenter",this.dragEnterHandler);b.off("dragover",this.dragEnterHandler);b.off("dragleave",this.dragLeaveHandler);b.off("drop",this.dropHandler);this.options.disableGlobalDnd&&(e(document).off("dragover",this.dragOverHandler),e(document).off("drop",this.dropHandler))}})});l("runtime/html5/filepaste",["base","runtime/html5/runtime",
"lib/file"],function(g,h,k){return h.register("FilePaste",{init:function(){var e=this.options,b=this.elem=e.container,a=".*",d,f,c,h;if(e.accept){d=[];f=0;for(c=e.accept.length;f<c;f++)(h=e.accept[f].mimeTypes)&&d.push(h);d.length&&(a=d.join(","),a=a.replace(/,/g,"|").replace(/\*/g,".*"))}this.accept=new RegExp(a,"i");this.hander=g.bindFn(this._pasteHander,this);b.on("paste",this.hander)},_pasteHander:function(e){var b=[],a=this.getRuid(),d,f,c,g,h;e=e.originalEvent||e;d=e.clipboardData.items;g=0;
for(h=d.length;g<h;g++)f=d[g],"file"===f.kind&&(c=f.getAsFile())&&b.push(new k(a,c));b.length&&(e.preventDefault(),e.stopPropagation(),this.trigger("paste",b))},destroy:function(){this.elem.off("paste",this.hander)}})});l("runtime/html5/filepicker",["base","runtime/html5/runtime"],function(g,h){var k=g.$;return h.register("FilePicker",{init:function(){var e=this.getRuntime().getContainer(),b=this,a=b.owner,d=b.options,f=k(document.createElement("label")),c=k(document.createElement("input")),g,h,l,
m;c.attr("type","file");c.attr("name",d.name);c.addClass("webuploader-element-invisible");f.on("click",function(){c.trigger("click")});f.css({opacity:0,width:"100%",height:"100%",display:"block",cursor:"pointer",background:"#ffffff"});d.multiple&&c.attr("multiple","multiple");if(d.accept&&0<d.accept.length){g=[];h=0;for(l=d.accept.length;h<l;h++)g.push(d.accept[h].mimeTypes);c.attr("accept",g.join(","))}e.append(c);e.append(f);m=function(b){a.trigger(b.type)};c.on("change",function(d){var f=arguments.callee,
e;b.files=d.target.files;e=this.cloneNode(!0);this.parentNode.replaceChild(e,this);c.off();c=k(e).on("change",f).on("mouseenter mouseleave",m);a.trigger("change")});f.on("mouseenter mouseleave",m)},getFiles:function(){return this.files},destroy:function(){}})});l("runtime/html5/transport",["base","runtime/html5/runtime"],function(g,h){var k=g.noop,e=g.$;return h.register("Transport",{init:function(){this._status=0;this._response=null},send:function(){var b=this.owner,a=this.options,d=this._initAjax(),
f=b._blob,c=a.server,h,k,l;a.sendAsBinary?(c+=(/\?/.test(c)?"&":"?")+e.param(b._formData),k=f.getSource()):(h=new FormData,e.each(b._formData,function(a,b){h.append(a,b)}),h.append(a.fileVal,f.getSource(),a.filename||b._formData.name||""));a.withCredentials&&"withCredentials"in d?(d.open(a.method,c,!0),d.withCredentials=!0):d.open(a.method,c);this._setRequestHeader(d,a.headers);k?(d.overrideMimeType("application/octet-stream"),g.os.android?(l=new FileReader,l.onload=function(){d.send(this.result);
l=l.onload=null},l.readAsArrayBuffer(k)):d.send(k)):d.send(h)},getResponse:function(){return this._response},getResponseAsJson:function(){return this._parseJson(this._response)},getStatus:function(){return this._status},abort:function(){var b=this._xhr;b&&(b.upload.onprogress=k,b.onreadystatechange=k,b.abort(),this._xhr=null)},destroy:function(){this.abort()},_initAjax:function(){var b=this,a=new XMLHttpRequest;!this.options.withCredentials||"withCredentials"in a||"undefined"===typeof XDomainRequest||
(a=new XDomainRequest);a.upload.onprogress=function(a){var f=0;a.lengthComputable&&(f=a.loaded/a.total);return b.trigger("progress",f)};a.onreadystatechange=function(){if(4===a.readyState)return a.upload.onprogress=k,a.onreadystatechange=k,b._xhr=null,b._status=a.status,200<=a.status&&300>a.status?(b._response=a.responseText,b.trigger("load")):500<=a.status&&600>a.status?(b._response=a.responseText,b.trigger("error","server")):b.trigger("error",b._status?"http":"abort")};return b._xhr=a},_setRequestHeader:function(b,
a){e.each(a,function(a,f){b.setRequestHeader(a,f)})},_parseJson:function(b){var a;try{a=JSON.parse(b)}catch(d){a={}}return a}})});l("runtime/flash/runtime",["base","runtime/runtime","runtime/compbase"],function(g,h,k){function e(){function b(a,d){var e=a.type||a,f,e=e.split("::");f=e[0];e=e[1];"Ready"===e&&f===k.uid?k.trigger("ready"):c[f]&&c[f].trigger(e.toLowerCase(),a,d)}var f={},c={},e=this.destory,k=this,l=g.guid("webuploader_");h.apply(k,arguments);k.type="flash";k.exec=function(b,d){var e=
this.uid,h=g.slice(arguments,2);c[e]=this;return a[b]&&(f[e]||(f[e]=new a[b](this,k)),e=f[e],e[d])?e[d].apply(e,h):k.flashExec.apply(this,arguments)};m[l]=function(){var a=arguments;setTimeout(function(){b.apply(null,a)},1)};this.jsreciver=l;this.destory=function(){return e&&e.apply(this,arguments)};this.flashExec=function(a,b){var c=k.getFlash(),d=g.slice(arguments,2);return c.exec(this.uid,a,b,d)}}var b=g.$,a={};g.inherits(h,{constructor:e,init:function(){var a=this.getContainer(),b=this.options,
c;a.css({position:"absolute",top:"-8px",left:"-8px",width:"9px",height:"9px",overflow:"hidden"});c='<object id="'+this.uid+'" type="application/x-shockwave-flash" data="'+b.swf+'" ';g.browser.ie&&(c+='classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" ');c+='width="100%" height="100%" style="outline:0"><param name="movie" value="'+b.swf+'" /><param name="flashvars" value="uid='+this.uid+"&jsreciver="+this.jsreciver+'" /><param name="wmode" value="transparent" /><param name="allowscriptaccess" value="always" /></object>';
a.html(c)},getFlash:function(){return this._flash?this._flash:this._flash=b("#"+this.uid).get(0)}});e.register=function(d,e){return e=a[d]=g.inherits(k,b.extend({flashExec:function(){var a=this.owner;return this.getRuntime().flashExec.apply(a,arguments)}},e))};11.4<=function(){var a;try{a=navigator.plugins["Shockwave Flash"],a=a.description}catch(b){try{a=(new ActiveXObject("ShockwaveFlash.ShockwaveFlash")).GetVariable("$version")}catch(c){a="0.0"}}a=a.match(/\d+/g);return parseFloat(a[0]+"."+a[1],
10)}()&&h.addRuntime("flash",e);return e});l("runtime/flash/filepicker",["base","runtime/flash/runtime"],function(g,h){var k=g.$;return h.register("FilePicker",{init:function(e){e=k.extend({},e);var b,a;b=e.accept&&e.accept.length;for(a=0;a<b;a++)e.accept[a].title||(e.accept[a].title="Files");delete e.button;delete e.container;this.flashExec("FilePicker","init",e)},destroy:function(){}})});l("runtime/flash/transport",["base","runtime/flash/runtime","runtime/client"],function(g,h,k){var e=g.$;return h.register("Transport",
{init:function(){this._status=0;this._responseJson=this._response=null},send:function(){var b=this.owner,a=this.options,d=this._initAjax(),f=b._blob,c=a.server,g;d.connectRuntime(f.ruid);a.sendAsBinary?(c+=(/\?/.test(c)?"&":"?")+e.param(b._formData),g=f.uid):(e.each(b._formData,function(a,b){d.exec("append",a,b)}),d.exec("appendBlob",a.fileVal,f.uid,a.filename||b._formData.name||""));this._setRequestHeader(d,a.headers);d.exec("send",{method:a.method,url:c},g)},getStatus:function(){return this._status},
getResponse:function(){return this._response},getResponseAsJson:function(){return this._responseJson},abort:function(){var b=this._xhr;b&&(b.exec("abort"),b.destroy(),this._xhr=null)},destroy:function(){this.abort()},_initAjax:function(){var b=this,a=new k("XMLHttpRequest");a.on("uploadprogress progress",function(a){return b.trigger("progress",a.loaded/a.total)});a.on("load",function(){var d=a.exec("getStatus"),e="";a.off();b._xhr=null;200<=d&&300>d?(b._response=a.exec("getResponse"),b._responseJson=
a.exec("getResponseAsJson")):500<=d&&600>d?(b._response=a.exec("getResponse"),b._responseJson=a.exec("getResponseAsJson"),e="server"):e="http";a.destroy();a=null;return e?b.trigger("error",e):b.trigger("load")});a.on("error",function(){a.off();b._xhr=null;b.trigger("error","http")});return b._xhr=a},_setRequestHeader:function(b,a){e.each(a,function(a,e){b.exec("setRequestHeader",a,e)})}})});l("preset/withoutimage","base widgets/filednd widgets/filepaste widgets/filepicker widgets/queue widgets/runtime widgets/upload widgets/validator runtime/html5/blob runtime/html5/dnd runtime/html5/filepaste runtime/html5/filepicker runtime/html5/transport runtime/flash/filepicker runtime/flash/transport".split(" "),
function(g){return g});l("webuploader",["preset/withoutimage"],function(g){return g});return r("webuploader")});